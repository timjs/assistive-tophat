% !TEX root=../main.tex

\section{Soundness proofs}
\label{sec:soundnessproofs}


\begin{proof}[Soundness of handle]

  We prove \cref{lem:soundhandle} by induction over $\tilde{t}$.

  \case{$\tilde{t}=\Enter \tau$}
 {One rule applies, namely \userule{SH-Fill}\\
 Since we have $t,\sigma\Consistent_M\Enter \tau,\tilde{\sigma},\Phi$, we know that $t$ must be $\Enter \tau$ too, $\tilde{t}$ contains no symbols.
 There exists only one symbolic execution, namely $\Enter \tau,\tilde{\sigma}\handle{}\Edit s,\tilde{\sigma},s,\True$.
 We need to show that there exists an $i$ such that $s\sim i$ and $\Edit v,\sigma\handle{i}t',\sigma'$.

 Any concrete value $c$ of type $\tau$ will do. Now we have to show that we end up with $\Edit c,\sigma\Consistent_{M.[s\mapsto c]}\Edit s,\tilde{\sigma},\Phi\land\True$, which holds trivially.
 }

  \case{$\tilde{t}=\Edit \tilde{v}$}
  {One rule applies, namely \userule{SH-Change}\\
  Since we have $t,\sigma\Consistent_M\Edit \tilde{v},\tilde{\sigma},\Phi$, we know that either $\tilde{v}$ is a concrete value, or $M$ contains a mapping such that $M\tilde{v}$ becomes a concrete value $c$. We know therefore that $t$ must be $\Edit c$.

  There exists only one symbolic execution, namely $\Edit \tilde{v},\tilde{\sigma}\handle{}\Edit s,\tilde{\sigma},s,\True$.
  We need to show that there exists an $i$ such that $s\sim i$ and $\Edit c,\sigma\handle{i}t',\sigma'$.

  Any concrete value $c'$ of the same type as $c$ will do. Now we have to show that we end up with $\Edit c',\sigma\Consistent_{M.[s\mapsto c']}\Edit s,\tilde{\sigma},\Phi\land\True$, which holds trivially.
  }


\case{$\tilde{t}=\Update l$}
{One rule applies, namely \userule{SH-Update}\\

Since we have $t,\sigma\Consistent_M\Update l,\tilde{\sigma},\Phi$, we know that $t$ must be $\Update l$ too, $\tilde{t}$ contains no symbols.
There exists only one symbolic execution, namely $\Update l,\tilde{\sigma}\handle{}\Update l,\tilde{\sigma}[l\mapsto s],s,\True$.
We need to show that there exists an $i$ such that $s\sim i$ and $\Update l,\sigma\handle{i}t',\sigma'$.

Any concrete value $c$ of the same type as $l$ will do. Now we have to show that we end up with $\Update l,\sigma[l\mapsto c]\Consistent_{M.[s\mapsto c]}\Update l,\tilde{\sigma}[l\mapsto s],\Phi\land\True$, which holds trivially.
}


\case{$\tilde{t}=\tilde{t}_1\Next \tilde{e}_2$}
 {
Since we have $t,\sigma\Consistent_M\tilde{t}_1\Next \tilde{e}_2,\tilde{\sigma},\Phi$, we know that $M \tilde{t}_1\Next \tilde{e}_2=t$, which comes down to $t_1\Next e_2$ for some concrete $t_1$ and $e_2$.

 In this case, two rules apply.\\

 \case{\userule{SH-Next}}

{
In this case, we have two sets of symbolic executions.

For all tuples $(\tilde{t}_1'\Next \tilde{e}_2,\tilde{\sigma}_1',\tilde{i},\phi_1)$, we know by application of the induction hypothesis that
there exits an $i$ such that $\tilde{i}\sim i$, $t_1,\sigma\handle{i}t_1',\sigma'$ and
$t_1',\sigma'\Consistent_{M.[s\mapsto c]}\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi_1$ where $c\in i$ and $s\in \tilde{i}$.
Therefore we also have $t_1'\Next e_2,\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1'\Next \tilde{e}_2,\tilde{\sigma}_1',\Phi\land\phi_1$.

For all tuples $(\tilde{t}_2,\tilde{\sigma}_2',\Continue,\phi_2)$, we first have by \cref{lem:valpres} that
$v_1,\sigma\Consistent_M\tilde{v}_1,\tilde{\sigma},\Phi$.
Now, before we can apply \cref{lem:soundnorm}, we need to establish that
$e_2\ v_1,\sigma\Consistent_M\tilde{e}_2\ \tilde{v}_1,\tilde{\sigma},\Phi$ holds.
This means that we have to show that $M \tilde{e}_2\ \tilde{v}_1 = e_2\ v_1$.
Since application of the mapping is distributive, it suffices to show that $M\tilde{v}_1=v_1$, which is given,
and $M\tilde{e}_2=e_2$, which follows from the premise as well.

At this point, by application of \cref{lem:soundnorm}, we obtain that $e_2\ v_1,\sigma\normalise t_2,\sigma_2'$
and $t_1,\sigma_2'\Consistent_M\tilde{t}_2,\tilde{\sigma}_2',\Phi\land\phi_2$
}
%
\case{\userule{SH-PassNext}}
{
For all tuples $(\tilde{t}_1'\Next \tilde{e}_2,\tilde{\sigma}_1',\tilde{i},\phi_1)$, we know by application of the induction hypothesis that
there exits an $i$ such that $\tilde{i}\sim i$, $t_1,\sigma\handle{i}t_1',\sigma'$ and
$t_1',\sigma'\Consistent_{M.[s\mapsto c]}\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi_1$ where $c\in i$ and $s\in \tilde{i}$.
Therefore we also have $t_1'\Next e_2,\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1'\Next \tilde{e}_2,\tilde{\sigma}_1',\Phi\land\phi_1$.
}
}

\case{$\tilde{t}=\tilde{t}_1\Then \tilde{e}_2$}
{One rule applies, namely \userule{SH-PassThen}\\
For all tuples $(\tilde{t}_1'\Then\tilde{e}_2,\tilde{\sigma}',\tilde{i},\phi)$, we know by application of the induction hypothesis that
there exists an $i$ such that $\tilde{i}\sim i$, $t_1,\sigma\handle{1}t_1',\sigma'$ and
$t_1',\sigma'\Consistent_{M.[s\mapsto c]}\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi_1$ where $c\in i$ and $s\in \tilde{i}$.
Therefore we also have $t_1'\Then e_2,\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1'\Then \tilde{e}_2,\tilde{\sigma}_1',\Phi\land\phi_1,M.[s\mapsto c])$.
}

\case{$\tilde{t}=\tilde{e}_1\Xor \tilde{e}_2$}
 {
In this case, three rules apply.\\
   \case{\userule{SH-Pick}}
   {
   In this case, we have two sets of symbolic executions.

   For all tuples $(\tilde{t}_1,\tilde{\sigma}_1,\Left,\phi_1)$,
   we obtain from \cref{lem:soundnorm} that $e_1,\sigma\normalise t_1,\sigma_1$ with
   $t_1,\sigma_1\Consistent_M\tilde{t}_1,\tilde{\sigma}_1,\Phi\land\phi_1$.

   For all tuples $(\tilde{t}_2,\tilde{\sigma}_2,\Right,\phi_2)$,
   we obtain from \cref{lem:soundnorm} that $e_2,\sigma\normalise t_2,\sigma_2$ with
   $t_2,\sigma_2\Consistent_M\tilde{t}_2,\tilde{\sigma}_2,\Phi\land\phi_2$.
   \todo{is it problematic that $i$ is not captured in the relation here?}
   }
%
 \case{\userule{SH-PickLeft}}
  {
  For all tuples $(\tilde{t}_1,\tilde{\sigma}_1,\Left,\phi_1)$,
  we obtain from \cref{lem:soundnorm} that $e_1,\sigma\normalise t_1,\sigma_1$ with
  $t_1,\sigma_1\Consistent_M\tilde{t}_1,\tilde{\sigma}_1,\Phi\land\phi_1$.
%
}
  \case{\userule{SH-PickRight}}
  {
  For all tuples $(\tilde{t}_2,\tilde{\sigma}_2,\Right,\phi_2)$,
  we obtain from \cref{lem:soundnorm} that $e_2,\sigma\normalise t_2,\sigma_2$ with
  $t_2,\sigma_2\Consistent_M\tilde{t}_2,\tilde{\sigma}_2,\Phi\land\phi_2$.
  }
 }
%
\case{$\tilde{t}=\tilde{t}_1\And \tilde{t}_2$}
{
In this case, one rule applies. \userule{SH-And}

In this case, we have two sets of symbolic executions.

  For all tuples $(\tilde{t}_1'\And\tilde{t}_2,\tilde{\sigma}_1',\First \tilde{i}_1,\phi_1)$,
  we know by application of the induction hypothesis that there exists an $i$ such that
  $\tilde{i}_1\sim i$, $t_1,\sigma\handle{i}t_1',\sigma_1'$ and
  $t_1',\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1',\tilde{\sigma}_1',\Phi\land\phi_1$.
  Then by \refrule{H-FirstAnd}, we know that also $t_1\And t_2,\sigma\handle{\First i}t_1'\And t_2,\sigma_1'$.
  It follows trivially that $t_1'\And t_2,\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1'\And \tilde{t}_2,\tilde{\sigma}_1',\Phi\land\phi_1$.

  For all tuples $(\tilde{t}_1\And\tilde{t}_2',\tilde{\sigma}_2',\Second \tilde{i}_2,\phi_2)$,
  we know by application of the induction hypothesis that there exists an $i$ such that
  $\tilde{i}_2\sim i$, $t_2,\sigma\handle{i}t_2',\sigma_2'$ and
  $t_2',\sigma_2'\Consistent_{M.[s\mapsto c]}\tilde{t}_2',\tilde{\sigma}_2',\Phi\land\phi_2$.
  Then by \refrule{H-SecondAnd}, we know that also $t_1\And t_2,\sigma\handle{\Second i}t_1\And t_2',\sigma_2'$.
  It follows trivially that $t_1\And t_2',\sigma_2'\Consistent_{M.[s\mapsto c]}\tilde{t}_1\And \tilde{t}_2',\tilde{\sigma}_2',\Phi\land\phi_2$.
}
%
 \case{$\tilde{t}=\tilde{e}_1\Or \tilde{e}_2$}
{One rule applies, namely \userule{SH-Or}\\
%
% In the case that $M\phi_1$, we need to demonstrate that \userule{H-FirstOr} with $\hat{\sigma}=M\sigma$ and $M\First i =\First j$,
% $M t_1'\Or t_2\equiv \hat{t_1'}\And t_2$ and $M\sigma'\equiv \hat{\sigma'}$.
%
% By the induction hypothesis we obtain the following.\\
% $\forall M_1 . M_1 \phi_1 \implies t_1,M_1\sigma \xrightarrow[]{M_1 i} \hat{t_1'},\hat{\sigma'}\land M_1 t_1'\equiv\hat{t_1'}\land M_1\sigma' \equiv \hat{\sigma'}$.
%
% Since $M$ satisfies $\phi$, we have $t_1,M\sigma\xrightarrow[]{M i} \hat{t_1'},\hat{\sigma'}$ and $M\sigma'\equiv\hat{\sigma'}$,
% which we needed to show, as well as $M t_1'\Or t_2\equiv \hat{t_1'}\And t_2$, which follows from $M t_1' \equiv \hat{t_1'}$.
%
% In the case that $M\phi_2$, we need to demonstrate that \userule{H-SecondOr} with $\hat{\sigma}=M\sigma$ and $M\Second i = \Second j$,
% $M t_1\Or t_2'\equiv t_1\And \hat{t_2}$ and $M\sigma'\equiv \hat{\sigma'}$.
%
% By the induction hypothesis we obtain the following.\\
% $\forall M_1 . M_1 \phi_1 \implies t_2,M_1\sigma \xrightarrow[]{M_1 i} \hat{t_2'},\hat{\sigma'}\land M_1 t_2'\equiv\hat{t_2'}\land M_1\sigma' \equiv \hat{\sigma'}$
%
% Since $M$ satisfies $\phi$, we have $t_2,M\sigma\xrightarrow[]{M i} \hat{t_2'},\hat{\sigma'}$ and $M\sigma'\equiv\hat{\sigma'}$,
% which we needed to show, as well as $M t_1\Or t_2'\equiv t_1\And \hat{t_2'}$, which follows from $M t_2' \equiv \hat{t_2'}$.
}

\end{proof}


\begin{lemma}[$\Value$ preserves consistence]
  \label{lem:valpres}
  For all concrete tasks $t$, concrete states $\sigma$, symbolic tasks $\tilde{t}$, symbolic states $\tilde{\sigma}$, path conditions $\Phi$ and mappings $M=[s_1\mapsto c_1\cdots s_n\mapsto c_n]$,
  if $t,\sigma\Consistent_M\tilde{t},\tilde{\sigma},\Phi$ and $\Value(t,\sigma)=v$ and $\Value(\tilde{t},\tilde{\sigma})$,
  then also $v,\sigma\Consistent_M\tilde{v},\tilde{\sigma},\Phi$
\end{lemma}

\begin{proof}[$\Value$ preserves consistence]

  \case{$\tilde{t}=\Edit s$}
    {
    If we have $t,\sigma\Consistent_M\Edit s,\tilde{\sigma},\Phi$, then we know that $t$ must be $\Edit c$ for some concrete value of the same type as $s$.

    Then by definition of $\Value$, we have $\Value(\Edit c,\sigma)=c$ and $\Value(\Edit s,\tilde{\sigma})=s$.
    Since we have $M(\Edit s)=\Edit c$ from the premise, we know that $M s = c$, since mapping propagates.
    Therefore $c,\sigma\Consistent_M s,\tilde{\sigma},\Phi$.
    }

  \case{$\tilde{t}=\Enter \tau$}
    {
    If we have $t,\sigma\Consistent_M\Enter \tau,\tilde{\sigma},\Phi$, then we know that $t$ is also $\Enter\tau$.

    By definition of $\Value$, $\Value(\Enter \tau,\sigma)=\bot$ and $\Value(\Enter\tau,\tilde{\sigma})=\bot$,
    so this case holds trivially.
    }

  \case{$\tilde{t}=\Update l$}
    {
    If we have $t,\sigma\Consistent_M\Update l,\tilde{\sigma},\Phi$, then we know that $t$ is also $\Update l$.

    By definition of $\Value$, $\Value(\Update l,\sigma)=\sigma(l)$ and $\Value(\Update l,\tilde{\sigma})=\tilde{\sigma}(l)$.

    We now need to show that $M(\tilde{\sigma}(l))=\sigma(l)$. From the premise we know that $M\tilde{\sigma}=\sigma$, from which this immediately follows.
    }

  \case{$\tilde{t}=\Fail$}
    {
    If we have $t,\sigma\Consistent_M\Fail,\tilde{\sigma},\Phi$, then we know that $t$ is also $\Fail$.

    By definition of $\Value$, $\Value(\Fail,\sigma)=\bot$ and $\Value(\Fail,\tilde{\sigma})=\bot$, so we know that this case holds trivially.
    }

  \case{$\tilde{t}=\tilde{t}_1\Then \tilde{e}_2$}
    {
    If we have $t,\sigma\Consistent_M\tilde{t}_1\Then \tilde{e}_2,\tilde{\sigma},\Phi$, then we know that $t$ is $t_1\Then e_2$.

    By definition of $\Value$, $\Value(t_1\Then e_2,\sigma)=\bot$ and $\Value(\tilde{t}_1\Then \tilde{e}_2,\tilde{\sigma})=\bot$, so we know that this case holds trivially.

    }


  \case{$\tilde{t}=\tilde{t}_1\Next \tilde{e}_2$}
    {
    If we have $t,\sigma\Consistent_M\tilde{t}_1\Next \tilde{e}_2,\tilde{\sigma},\Phi$, then we know that $t$ is $t_1\Next e_2$.

    By definition of $\Value$, $\Value(t_1\Next e_2,\sigma)=\sigma(l)$ and $\Value(\tilde{t}_1\Next \tilde{e}_2,\tilde{\sigma})=\bot$, so we know that this case holds trivially.

    }

  \case{$\tilde{t}=\tilde{t}_1\And \tilde{t}_2$}
    {
    If we have $t,\sigma\Consistent_M\tilde{t}_1\And \tilde{t}_2,\tilde{\sigma},\Phi$, then we know that $t$ is also $t_1\And t_2$.

    By definition of $\Value$, we can find ourselves in one of two cases.

    If $\Value(\tilde{t}_1,\sigma)=\tilde{v}_1$ and $\Value(\tilde{t}_2,\sigma)=\tilde{v}_2$,
    then $\Value(t_1\And t_2,\sigma)=\tuple{v_1,v_2}$ and $\Value(\tilde{t}_1\And \tilde{t}_2,\tilde{\sigma})=\tuple{\tilde{v}_1,\tilde{v}_2}$.
    This case follows from the induction hypothesis.

    Otherwise, if either one of the two branches returns $\bot$, we have that
    $\Value(t_1\And t_2,\sigma)=\bot$ and $\Value(\tilde{t}_1\And \tilde{t}_2,\tilde{\sigma})=\bot$,
    so we know that this case holds trivially

    }

  \case{$\tilde{t}=\tilde{t}_1\Or \tilde{t}_2$}
    {
    If we have $t,\sigma\Consistent_M\tilde{t}_1\Or \tilde{t}_2,\tilde{\sigma},\Phi$, then we know that $t$ is also $t_1\Or t_2$.

    By definition of $\Value$, we find ourselves in one of three cases.

    If $\Value(\tilde{t}_1,\tilde{\sigma})=\tilde{v}_1$, then $\Value(\tilde{t}_1\Or\tilde{t}_2,\tilde{\sigma})=\tilde{v}_1$
    and $\Value(t_1\Or t_2,\sigma)=v_1$. This case follows from the induction hypothesis.

    Otherwise, if $\Value(\tilde{t}_2,\tilde{\sigma})=\tilde{v}_2$, then $\Value(\tilde{t}_1\Or\tilde{t}_2,\tilde{\sigma})=\tilde{v}_2$
    and $\Value(t_1\Or t_2,\sigma)=v_2$. This case follows from the induction hypothesis.

    Otherwise, if either one of the two branches returns $\bot$, we have that
    $\Value(t_1\Or t_2,\sigma)=\bot$ and $\Value(\tilde{t}_1\Or \tilde{t}_2,\tilde{\sigma})=\bot$,
    so we know that this case holds trivially.

    }

  \case{$\tilde{t}=\tilde{t}_1\Xor \tilde{t}_2$}
    {
    If we have $t,\sigma\Consistent_M\tilde{t}_1\Xor \tilde{t}_2,\tilde{\sigma},\Phi$, then we know that $t$ is $t_1\Xor t_2$.

    By definition of $\Value$, $\Value(t_1\Xor t_2,\sigma)=\bot$ and $\Value(\tilde{t}_1\Xor \tilde{t}_2,\tilde{\sigma})=\bot$, so we know that this case holds trivially.

    }
\end{proof}

\begin{proof}[Soundness of normalise]
  We prove Lemma~\ref{lem:soundnorm} by induction over $\tilde{e}$.

  From the premise, we can assume that $e,\sigma\Consistent_M\tilde{e},\tilde{\sigma},\Phi$.
  Now, given that $\tilde{e},\sigma{e}\tilde{\normalise} \overline{\tilde{t},\tilde{\sigma}',\phi}$,
  we need to demonstrate that for all pairs $(\tilde{t},\tilde{\sigma}',\phi)$,
  $\Sat(\Phi\land\phi)$ implies that $e,\sigma\normalise t,\sigma'$ with $t,\sigma'\Consistent_M\tilde{t},\tilde{\sigma}',\Phi\land\phi$.

The base case is when the SN-Done rule applies.\\
\userule{SN-Done}\\

In this case, we obtain from \cref{lem:soundeval} that
$e,\sigma\normalise t,\sigma'$ with $t,\sigma'\Consistent_M\tilde{t},\tilde{\sigma}',\Phi\land\phi$,
which is exactly what we needed to show.

The only induction step is when\\
\userule{SN-Repeat} applies.

In this case, we obtain from \cref{lem:soundeval} that
$e,\sigma\normalise t,\sigma'$ with $t,\sigma'\Consistent_M\tilde{t},\tilde{\sigma}',\Phi\land\phi_1$,
which is exactly what we needed to show.
Furthermore, by \cref{lem:soundstride} we obtain that
$t,\sigma'\stride t',\sigma''$ with $t',\sigma''\Consistent_M\tilde{t}',\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
Then finally, by application of the induction hypothesis, we obtain what we needed to prove.
$t',\sigma''\normalise t'',\sigma'''$ with $t'',\sigma'''\Consistent_M\tilde{t}'',\tilde{\sigma}''',\Phi\land\phi_1\land\phi_2\land\phi_3$.

\end{proof}

\begin{proof}[Soundness of stride]

  Provided that $t,\sigma\Consistent_M\tilde{t},\tilde{\sigma},\Phi$ and $\tilde{t},\tilde{\sigma}\tilde{\stride} \overline{\tilde{t}',\tilde{\sigma}',\phi}$,
  we want to show that for all pairs $(\tilde{t}',\tilde{\sigma}',\phi)$,
  we have $\Sat(\Phi\land\phi)$ implies that $t,\sigma\stride t',\sigma'$
  We prove Lemma~\ref{lem:soundstride} by induction over $t$.



  \case{$\tilde{t}=\Edit \tilde{v}$}
  { One rule applies, namely \userule{SS-Edit}\\
  % Provided that $M\True$, we need to demonstrate that \userule{S-Edit} with $\hat{\sigma}=M\sigma$,
  % $M\Edit v \equiv \Edit \hat{v}$ and $M\sigma \equiv \hat{\sigma}$.
  % This holds trivially.
  %
   }
  %
   \case{$t=\Enter \tau$}
  {One rule applies, namely \userule{SS-Fill}\\
  % Provided that $M\True$, we need to demonstrate \userule{S-Fill} with $\hat{\sigma}=M\sigma$,
  % $M\Enter \tau \equiv \Enter \tau$ and $M\sigma \equiv \hat{\sigma}$.
  % This holds trivially.
  }

  \case{$t=\Update l$}
   {One rule applies, namely \userule{SS-Update}\\
  % Provided that $M\True$, we need to demonstrate \userule{S-Update} with $\hat{\sigma}=M\sigma$,
  % $M\Update l \equiv \Update l$ and $M\sigma \equiv \hat{\sigma}$.
  % This holds trivially.
  }

  \case{$t=\Fail$}
   {One rule applies, namely \userule{SS-Fail}\\
  % Provided that $M\True$, we need to demonstrate that \userule{S-Fail} with $\hat{\sigma}=M\sigma$,
  % $M\Fail \equiv \Fail$ and $M\sigma \equiv \hat{\sigma}$.
  % This holds trivially.
   }
  %
  \case{$t=e_1\Xor e_2$}
   {One rule applies, namely \userule{SS-Xor}\\
  % Provided that $M\True$, we need to demonstrate that \userule{S-Xor} with $\hat{\sigma}=M\sigma$,
  % $M e_1\Xor e_2 \equiv e_1\Xor e_2$ and $M\sigma \equiv \hat{\sigma}$.
  % This holds trivially.
   }




\case{$\tilde{t}=\tilde{t}_1\Then \tilde{e}_2$}
 {
Three rules apply.\\
 \case{\userule{SS-ThenStay}}
   {
%   Provided that $M\phi\equiv\True$
%   we need to demonstrate that
%   \userule{S-ThenStay} with $\hat{\sigma}=M\sigma$,
%   $M t_1'\Then e_2 \equiv \hat{t_1'}\Then e_2 $ and $ M\sigma'\equiv \hat{\sigma'}$.
%
%   From the induction hypothesis, we obtain the following.\\
%   $\forall M_1 . M_1 \phi \implies t_1,M_1\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}\land M_1 t_1'\equiv\hat{t_1'}\land M_1\sigma' \equiv \hat{\sigma'}$.
%
%   Since $M$ satisfies $\phi$,
%   we know that
%   $t_1,M\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}$
%   and $M t_1'\equiv\hat{t_1'}$,
%   and therefore also $M t_1'\Then e_2 \equiv \hat{t_1'}\Then e_2$,
%   and from the induction hypothesis, we directly obtain  $M\sigma'\equiv \hat{\sigma'}$.
  }
 \case{\userule{SS-ThenFail}}
   { %Provided that $M\phi\equiv\True$
%   we need to demonstrate that
%   \userule{S-ThenFail} with $\hat{\sigma}=M\sigma$,
%   $M t_1'\Then e_2 \equiv \hat{t_1'}\Then e_2$ and $M\sigma'\equiv \hat{\sigma'}$.
%
%   From the induction hypothesis, we obtain the following.\\
%   $\forall M_1 . M_1 \phi \implies t_1,M_1\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}\land M_1 t_1'\equiv\hat{t_1'}\land M_1\sigma' \equiv \hat{\sigma'}$.
%
%   Since $M$ satisfies $\phi$,
%   we know that
%   $t_1,M\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}$
%   and $M t_1'\equiv\hat{t_1'}$,
%   and therefore also $M t_1'\Then e_2 \equiv \hat{t_1'}\Then e_2$,
%   and from the induction hypothesis, we directly obtain  $M\sigma'\equiv \hat{\sigma'}$.
   }
 \case{\userule{SS-ThenCont}}
   {
   %Provided that $M\phi_1\land M\phi_2$
%   we need to demonstrate that
%   \userule{S-ThenCont} with $\hat{\sigma}=M\sigma$,
%   $M t_2 \equiv \hat{t_2}\Then e_2$ and $M\sigma''\equiv \hat{\sigma''}$.
%
%   From the induction hypothesis, we obtain the following.\\
%   $\forall M_1 . M_1 \phi_1 \implies t_1,M_1\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}\implies M_1 t_1'\equiv\hat{t_1'}\land M_1\sigma' \equiv \hat{\sigma'}$.\\
%   From Lemma~\ref{lem:soundeval} we know that\\
%   $\forall M_2 . M_2 \phi_2 \implies e_2\hat{v_1}M_2\sigma'\hat{\eval}\hat{t_2},\hat{\sigma''}\and M_2 t_2\equiv \hat{t_2}\land M_2\sigma''\equiv \hat{\sigma''}$.
%
%   Since $M$ satisfies both $\phi_1$ and $\phi_2$,
%   we know that
%   $t_1,M\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}$ and $e_2\hat{v_1}M\sigma'\hat{\eval}\hat{t_2},\hat{\sigma''}$,
%   $M t_2\equiv\hat{t_2}$,
%   and from the induction hypothesis, we directly obtain  $M\sigma''\equiv \hat{\sigma''}$.
%
   }
 }

\case{$\tilde{t}=\tilde{t}_1\Or \tilde{t}_2$}
 {
% Three rules apply.\\
\case{\userule{SS-OrLeft}}
   {%Provided that $M\phi\equiv\True$
%   we need to demonstrate that
%   \userule{S-OrLeft} with $\hat{\sigma}=M\sigma$,
%   $M t_1'\equiv \hat{t_1'}$ and $M\sigma'\equiv \hat{\sigma'}$.
%
%   From the induction hypothesis, we obtain the following.\\
%   $\forall M_1 . M_1 \phi \implies t_1,M_1\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}\and M_1 t_1'\equiv\hat{t_1'}\land M_1\sigma' \equiv \hat{\sigma'}$.
%
%   Since $M$ satisfies $\phi$, we know that $t_1,M\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}$,
%   $M t_1'\equiv\hat{t_1'}$ and $M\sigma'\equiv \hat{\sigma'}$.
%
  }
 \case{\userule{SS-OrRight}}
   { %Provided that $M\phi_1\land M\phi_2$
%   we need to deomstrate that
%   \userule{S-OrRight} with $\hat{\sigma}=M\sigma$,
%   $M t_2'\equiv \hat{t_2'}$ and $M\sigma''\equiv \hat{\sigma''}$.
%
%   From the induction hypothesis, we obtain the following.\\
%   $\forall M_1 . M_1 \phi_1 \implies t_1,M_1\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}\land M_1 t_1'\equiv\hat{t_1'}\land M_1\sigma' \equiv \hat{\sigma'}$ and\\
%   $\forall M_2 . M_2 \phi_2 \implies t_2,M_2\sigma' \hat{\stride} \hat{t_2'},\hat{\sigma''}\land M_2 t_2'\equiv\hat{t_2'}\land M_2\sigma'' \equiv \hat{\sigma''}$.
%
%   Since $M$ satisfies both $\phi_1$ and $\phi_2$,
%   we know that
%   $t_1,M\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}$ and $t_2,M\sigma'\hat{\stride}\hat{t_2'},\hat{\sigma''}$,
%   $M t_2'\equiv\hat{t_2'}$ and $M\sigma''\equiv \hat{\sigma''}$.
%
   }
\case{\userule{SS-OrNone}}
  { %Provided that $M\phi_1\land M\phi_2$
%   we need to demonstrate that
%   \userule{S-OrNone} with $\hat{\sigma}=M\sigma$,
%   $M t_1'\Or t_2'\equiv \hat{t_1'}\Or\hat{t_2'}$ and $M\sigma''\equiv \hat{\sigma''}$.
%
%   From the induction hypothesis, we obtain the following.\\
%   $\forall M_1 . M_1 \phi_1 \implies t_1,M_1\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}\land M_1 t_1'\equiv\hat{t_1'}\land M_1\sigma' \equiv \hat{\sigma'}$ and\\
%   $\forall M_2 . M_2 \phi_2 \implies t_2,M_2\sigma' \hat{\stride} \hat{t_2'},\hat{\sigma''}\land M_2 t_2'\equiv\hat{t_2'}\land M_2\sigma'' \equiv \hat{\sigma''}$.
%
%   Since $M$ satisfies both $\phi_1$ and $\phi_2$,
%   we know that $t_1,M\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}$ and $t_2,M\sigma'\hat{\stride}\hat{t_2'},\hat{\sigma''}$,
%   $M t_1'\Or t_2'\equiv \hat{t_1'}\Or\hat{t_2'}$ and $M\sigma''\equiv \hat{\sigma''}$.
%
   }
 }

 \case{$t=t_1\Next e_2$}
 {One rule applies, namely \userule{SS-Next}\\
% Provided that $M\phi$,
% we need to demonstrate that \userule{S-Xor} with $\hat{\sigma}=M\sigma$,
% $M t_1'\Next e_2\equiv \hat{t_1'}\Next e_2$ and $M \sigma'\equiv\hat{\sigma'}$.

% From the induction hypothesis, we obtain the following.\\
% $\forall M_1 . M_1 \phi \implies t_1,M_1\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}\land M_1 t_1'\equiv\hat{t_1'}\land M_1\sigma' \equiv \hat{\sigma'}$.
%
% Since $M$ satisfies $\phi$, we directly obtain $t_1,M_1\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}$,
% $M t_1'\Next e_2\equiv \hat{t_1'}\Next e_2$ and $M \sigma'\equiv\hat{\sigma'}$.
%
}

\case{$t=t_1\And t_2$}
{One rule applies, namely \userule{SS-And}\\
% Provided that $M\phi_1\land M\phi_2$
% we need to demonstrate $\userule{S-And}$ with $\hat{\sigma}=M\sigma$,
% $M t_1'\And t_2'\equiv \hat{t_1'}\And\hat{t_2'}$ and $M\sigma''\equiv \hat{\sigma''}$.
%
% From the induction hypothesis, we obtain the following.\\
% $\forall M_1 . M_1 \phi_1 \implies t_1,M_1\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}\and M_1 t_1'\equiv\hat{t_1'}\land M_1\sigma' \equiv \hat{\sigma'}$ and\\
% $\forall M_2 . M_2 \phi_2 \implies t_2,M_2\sigma' \hat{\stride} \hat{t_2'},\hat{\sigma''}\and M_2 t_2'\equiv\hat{t_2'}\land M_2\sigma'' \equiv \hat{\sigma''}$.
%
% Since $M$ satisfies both $\phi_1$ and $\phi_2$,
% we know that $t_1,M\sigma \hat{\stride} \hat{t_1'},\hat{\sigma'}$ and $t_2,M\sigma'\hat{\stride}\hat{t_2'},\hat{\sigma''}$,
% $M t_1'\Or t_2'\equiv \hat{t_1'}\Or\hat{t_2'}$ and $M\sigma''\equiv \hat{\sigma''}$.

}

\end{proof}

\begin{proof}[Soundness of evaluate]

\end{proof}
