% !TEX root=../main.tex

\section{Properties}
\label{sec:properties}

In this section, we want to validate our approach by proving correctness.
For the hints function, which forms the heart of Assistive \TOPHAT, we want to prove that its results are both sound and complete.
Since the hints function relies on \STOPHAT, and more specifically, the simulate function,
we first prove correctness of simulate.


\subsection{Correctness of simulate}

The symbolic execution semantics is correct when all symbolic runs relate to a concrete run,
and the other way around, when all concrete runs are contained in the set of all symbolic executions.
These properties are defined as soundness and completeness respectively.

The simulate function can be considered a big-step symbolic execution semantics.
In order to prove certain properties with respect to the concrete semantics,
we need a concrete big-step concrete execution semantics.
Therefore the evaluate function is defined.

\begin{definition}[Evaluate]
  $t,\sigma\interact{I}^* v$ where

  \begin{minipage}[c]{0.4\textwidth}
    \begin{align*}
      t,\sigma             & \interact{i_1}  t_1,\sigma_1\\
      t_1,\sigma_1         & \interact{i_2}  t_2,\sigma_2\\
                           & \hspace{3mm}\vdots    \\
      t_{n-1},\sigma_{n-1} & \interact{i_n}  t_n,\sigma_n
    \end{align*}
\end{minipage}
\begin{minipage}[c]{0.1\textwidth}
  \Quad
\end{minipage}
\begin{minipage}[c]{0.3\textwidth}
  \begin{align*}
  \text{With }&\Value(t_n,\sigma_n)=v\\
  &\Value(t_{i<n},\sigma_{i<n})=\bot\\
  &I=i_1,\cdots,i_n
\end{align*}
\end{minipage}
\label{def:evaluate}
\end{definition}

Using the evaluate definition, we can state soundness and completeness for $\Simulate$ are listed below.

\begin{lemma}[Soundness of simulate]
  \label{lem:soundsimulate}
  For all tasks $t$ and states $\sigma$
  such that $t,\sigma\simulate\overline{\tilde{v},\tilde{I},\Phi}$
  then for all results $(\tilde{v},\tilde{I}=[\tilde{\imath}_0,\cdots,\tilde{\imath}_n],\Phi)$
  there exists a concrete input $I$ with the same length as the symbolic input $\tilde{I}$
  such that $t,\sigma\interact{I}^*v$
  with $[s_i\mapsto c_i]\tilde{v}=v$ and $[s_i\mapsto c_i]\Phi$
  where $s_i\in\tilde{i_i}$ and $c_i\in i_i$.
\end{lemma}

\begin{lemma}[Completeness of simulate]
  \label{lem:completesimulate}
  For all tasks $t$, states $\sigma$ and lists of input $I$
  such that $t,\sigma\interact{I}^*v$
  there exists a symbolic value $\tilde{v}$ and a symbolic input $\tilde{I}$ with the same length as $I$,
  such that $(\tilde{v},\tilde{I},\Phi)\in t,\sigma\simulate$,
  with $\tilde{i_i}\sim i_i$, $[s_i\mapsto c_i]\tilde{v}=v$ and $[s_i\mapsto c_i]\Phi$,
  where $s_i\in\tilde{i_i}$ and $c_i\in i_i$.
\end{lemma}

Where $\tilde{\imath}\sim i$ is defined as follows.

\begin{definition}[Input simulation]
  A symbolic input $\tilde{\imath}$ simulates a concrete input $i$ denoted as $\tilde{\imath}\sim i$ in the following cases.\\
  $s\sim a$, where $s$ is a symbol and $a$ a concrete action.\\
  $\tilde{\imath}\sim i\implies \First \tilde{\imath} \sim \First i$\\
  $\tilde{\imath}\sim i\implies \Second \tilde{\imath} \sim \Second i$
\end{definition}

And $s\in \tilde{\imath}$ and $c\in i$ are defined as follows.\\
\\
\noindent
\begin{minipage}[c]{0.5\textwidth}
  \begin{definition}[Value from input]\\
    $c\in \First i = c\in i $\\
    $c\in \Second i = c\in i $\\
    $c\in a = a $
  \end{definition}
\end{minipage}
\begin{minipage}[c]{0.5\textwidth}
  \begin{definition}[Symbol from input]\\
    $s\in \First \tilde{\imath} = s\in \tilde{\imath} $\\
    $s\in \Second \tilde{\imath} = s\in \tilde{\imath} $\\
    $s\in a = a $
  \end{definition}
\end{minipage}\\
\\

Our strategy to prove these two lemma's is outlined in \cref{fig:proofstructure}.

\begin{figure}[t]
  \tikzstyle{drive} = [decoration={markings,mark=at position
     1 with {\arrow[semithick]{angle 60}}},
     double distance=1.4pt, shorten >= 2.3pt,
     preaction = {decorate},
     postaction = {draw,line width=1pt, white,shorten >= 2.3pt}]
  \tikzstyle{sdrive} = [->,decorate, decoration={coil,aspect=0,amplitude=.5mm},
     double distance=1.4pt, shorten >= 2.3pt,]

\begin{tikzpicture}[
            > = stealth, % arrow head style
            shorten > = 1pt, % don't touch arrow head to node
            auto,
            node distance = 3cm, % distance between nodes
            semithick, % line style
        ]


        % j = 0
        \node (0)  {$t,\sigma$};
        \node (l0) [right of=0,xshift=1.4cm] {$t,\sigma\Consistent_{[\ ]} t,\sigma,\True$};

        % j = 1
        \node (c1) [below left of=0] {$t_1,\sigma_1$};
        \node (s1) [below right of=0] {$\tilde{t}_1,\tilde{\sigma}_1,\tilde{i}_1,\phi_1$};
        \node (l1) [right of=s1,text width=4cm] {\begin{tabular}{l}
        $t_1,\sigma_1\Consistent_{[s_1\mapsto c_1]}\tilde{t_1},\tilde{\sigma_1},\phi_1$\\
                                  $\Sat(\phi_1)$\\
                                  $\Value(t_1,\sigma_1)=\bot$\end{tabular}};

        %
        \node (cc) [below of=c1,yshift=1.5cm] {\vdots};
        \node (ss) [below of=s1,yshift=1.5cm] {\vdots};

        % j = k
        \node (ck) [below of=cc,yshift=1.5cm] {$t_k,\sigma_k$};
        \node (sk) [below of=ss,yshift=1.5cm] {$\tilde{t}_k,\tilde{\sigma}_k,\tilde{i}_k\phi_k$};
        \node (lk) [right of=sk,text width=4cm] {\begin{tabular}{l}
        $t_k,\sigma_k\Consistent_{[s_1\mapsto c_1,\cdots,s_k\mapsto c_k]}\tilde{t_k},\tilde{\sigma_k},\phi_1\land\cdots\land\phi_k$\\
        $\Sat(\phi_1\land\cdots\land\phi_k)$\\
        $\Value(t_k,\sigma_k)=\bot$\end{tabular}};

        %
        \node (ccc) [below of=ck,yshift=1.5cm] {\vdots};
        \node (sss) [below of=sk,yshift=1.5cm] {\vdots};

        \node (cn) [below of=ccc,yshift=1.5cm] {$t_n,\sigma_n$};
        \node (sn) [below of=sss,yshift=1.5cm] {$\tilde{t}_n,\tilde{\sigma}_n,\tilde{i}_n,\phi_n$};
        \node (l1) [right of=sn,text width=4cm] {\begin{tabular}{l}
        $t_n,\sigma_n\Consistent_{[s_1\mapsto c_1,\cdots,s_n\mapsto c_n]}\tilde{t_n},\tilde{\sigma_n},\phi_1\land\cdots\land\phi_n$\\
        $\Sat(\phi_1\land\cdots\land\phi_n)$\\
        $\Value(t_n,\sigma_n)=v$\Quad $\Value(\tilde{t}_n,\tilde{\sigma}_n)=\tilde{v}$\\
        $I=[i_1,\cdots,i_n]$\Quad $\tilde{I}=[\tilde{i}_1,\cdots,\tilde{i}_n]$\end{tabular}};

        \draw[drive] (0) to (c1);
        \node (0label) [below left of=0,yshift=1.3cm,xshift=0.8cm] {$i_1$};
        \draw[sdrive] (0) -- (s1);

        \draw[drive] (c1) to (cc);
        \draw[sdrive] (s1) -- (ss);

        \draw[drive] (cc) to (ck);
        \node (cclabel) [below left of=cc,yshift=1.5cm,xshift=1.8cm] {$i_k$};
        \draw[sdrive] (ss) -- (sk);

        \draw[drive] (ck) to (ccc);
        \draw[sdrive] (sk) -- (sss);

        \draw[drive] (ccc) to (cn);
        \node (cnlabel) [below left of=ccc,yshift=1.5cm,xshift=1.8cm] {$i_n$};
        \draw[sdrive] (sss) -- (sn);


        \path[dashed,->] ([yshift=.25em]c1.east) edge node {\cref{lem:completedriving}} ([yshift=.25em]s1.west);
        \path[dashed,->] ([yshift=-.25em]s1.west) edge node {\cref{lem:sounddriving}} ([yshift=-.25em]c1.east);

        \path[dashed,->] ([yshift=.25em]ck.east) edge node {\cref{lem:completedriving}} ([yshift=.25em]sk.west);
        \path[dashed,->] ([yshift=-.25em]sk.west) edge node {\cref{lem:sounddriving}} ([yshift=-.25em]ck.east);

        \path[dashed,->] ([yshift=.25em]cn.east) edge node {\cref{lem:completesimulate}} ([yshift=.25em]sn.west);
        \path[dashed,->] ([yshift=-.25em]sn.west) edge node {\cref{lem:soundsimulate}} ([yshift=-.25em]cn.east);


    \end{tikzpicture}
    \caption{Proof structure}
      \label{fig:proofstructure}
\end{figure}

At the top, we start out with any task $t$ and state $\sigma$.
The left side of the diagram is an overview of the evaluate function.
Inputs $i_1$ until $i_n$ are sequentially applied, until the task has an observable value.

On the right side, symbolic execution is performed.
One step of the driving semantics is taken, which results in a symbolic task, state, input
and a path condition.
Provided that the path condition holds, driving is executed sequentially until the symbolic task has an observable symbolic value.

Proving soundness and completeness of simulate now comes down to relating the left and right side of the diagram.
From symbolic to concrete, right to left, is soundness, as stated in \cref{lem:soundsimulate}.
From concrete to symbolic, left to right, is completeness, as stated in \cref{lem:soundsimulate}.

Since simulate and evaluate rely on the (symbolic) handling semantics,
we prove soundness and completeness of those semantics first.
Looking at \cref{fig:proofstructure}, there are two different settings in which the (symbolic) handling semantics are applied.
At the top, both symbolic and concrete execution start out with the same task and state.
But further down, the task and state differ for both semantics.
The task and state are related to each other however.
Symbolic execution introduces symbols, the concrete semantics handles concrete values.
This relation is expressed by the consistence relation listed in \cref{def:consistence}.

\begin{definition}[Consistence relation $\Consistent$]
  \label{def:consistence}
A concrete task $t$ and concrete state $\sigma$
are considered to be consistent with a symbolic task $\tilde{t}$, symbolic state $\tilde{\sigma}$ and path condition $\Phi$
under a certain mapping $M=[s_1\mapsto c_1,\cdots,s_n,\mapsto c_n]$, denoted as $t,\sigma \Consistent_M \tilde{t},\tilde{\sigma},\Phi$
if and only if $M\tilde{t}=t$, $M\tilde{\sigma}=\sigma$ and $M\Phi$
\end{definition}

Now \cref{lem:sounddriving} and \cref{lem:completedriving} express soundness and completeness of driving respectively.

\begin{lemma}[Soundness of driving]
  \label{lem:sounddriving}
  For all concrete tasks $t$, concrete states $\sigma$, symbolic tasks $\tilde{t}$, symbolic states $\tilde{\sigma}$ path conditions $\Phi$ and mappings $M$,
  we have that $t,\sigma\Consistent_M\tilde{t},\tilde{\sigma},\Phi$ implies
  that for all pairs $(\tilde{t}',\tilde{\sigma}',\tilde{\imath},\phi)$ in $\tilde{t},\tilde{\sigma}\interact{}\overline{\tilde{t}',\tilde{\sigma}',\tilde{\imath},\phi}$,
  $\Sat(\Phi\land\phi)$ implies that there exists an input $i$ such that $\tilde{\imath}\sim i$,  $t,\sigma\interact{i}t',\sigma'$ and $t',\sigma' \Consistent_{M.[s\mapsto c]} \tilde{t}',\tilde{\sigma}',\Phi\land\phi$ where where $s\in\tilde{\imath}$ and $c\in i$.
\end{lemma}

\begin{lemma}[Completeness of driving]
  \label{lem:completedriving}
  For all concrete tasks $t$, concrete states $\sigma$, symbolic tasks $\tilde{t}$, symbolic states $\tilde{\sigma}$ path conditions $\Phi$ and mappings $M$,
  we have that $t,\sigma\Consistent_{M}\tilde{t},\tilde{\sigma},\Phi$ implies
  that for all inputs $i$ such that $t,\sigma\interact{i}t',\sigma'$,
  there exists a symbolic input $\tilde{\imath}$, $\tilde{\imath}\sim i$ such that
  $\tilde{t},\tilde{\sigma}\interact{}\overline{\tilde{t}',\tilde{\sigma}',\tilde{\imath},\phi}$, $\Sat(\Phi\land\phi)$ and $t',\sigma'\Consistent_{M.[s\mapsto c]}\tilde{t}',\tilde{\sigma}',\Phi\land\phi$ where where $s\in\tilde{\imath}$ and $c\in i$.
\end{lemma}

In other words, if a symbolic and concrete task and state are related, they will still be related after (symbolic) handling.

The top case, where both the symbolic and concrete semantics start out with the same task and state, can be seen as a special case of the consistence relation.
Obviously a task and state are consistent with themselves, using the empty mapping and the path condition $\True$.

The full proof of all four lemma's is listed below.

\begin{proof}[Soundness of simulate]
  The structure of this proof is outlined in \cref{fig:proofstructure}.

  We have $t$ and $\sigma$ such that $t,\sigma\interact{}^*\overline{\tilde{v},\tilde{I},\Phi}$.
  By definition of simulation $(\interact{}^*)$, we know that for each tuple $(\tilde{v},\tilde{I},\Phi)$,
  the following sequence of symbolic drive steps has occurred.
  \begin{align*}
      t,\sigma\interact{}&\tilde{t}_1,\tilde{\sigma}_1,\tilde{\imath}_1,\phi_1&\\
                      &\tilde{t}_1,\tilde{\sigma}_1\interact{}&\tilde{t}_2,\tilde{\sigma}_2,\tilde{\imath}_2,\phi_2\\
                      &                                    &\tilde{t}_2,\tilde{\sigma}_2\interact{}&\cdots&\\
                      &                                    &                                    &\cdots&
                      \interact{}\tilde{t}_n,\tilde{\sigma}_n,\tilde{\imath}_n,\phi_n
  \end{align*}

  with $\Value(\tilde{t}_n,\tilde{\sigma}_n)=\tilde{v}$ and $\Sat(\phi_1\land\cdots\land\phi_n)$.

  We need to show that there exits an $I$ such that $t,\sigma\interact{I}^*v$, which is defined similarly as follows.

  $t,\sigma\interact{i_1}t_1,\sigma_1\interact{i_2}t_2,\sigma_2\interact{i_3}\cdots \interact{i_n}t_n,\sigma_n$ with $\Value(t_n,\sigma_n)$.

  By \cref{lem:sounddriving}, we know that $t,\sigma\interact{i_1}t_1,\sigma_1$ exists, since $t,\sigma\Consistent_{\emptyset}t,\sigma,\True$.
  This also gives us that $\tilde{i_1}\sim i_1$, and $t_1,\sigma_1\Consistent_{[s_1\mapsto c_1]}\tilde{t}_1,\tilde{\sigma}_1,\phi_1$ with $s_1\in\tilde{\imath}_1$ and $c_1\in i_1$.

  By repeatedly applying \cref{lem:sounddriving}, until we arrive at $\tilde{t}_n,\sigma{t}_n$,
  we can show that there indeed exists an $I$ such that $t,\sigma\interact{I}^*v$ with $[s_1\mapsto c_1,\cdots,s_n\mapsto c_n]\tilde{v}=v$
  and $[s_1\mapsto c_1,\cdots,s_n\mapsto c_n]\Phi$, namely $I=[i_1,\cdots,i_n]$.

\end{proof}



\begin{proof}[Completeness of simulate]
  The structure of this proof is outlined in \cref{fig:proofstructure}.

  We have $t$ and $\sigma$ such that $t,\sigma\interact{I}^*v$.
  By definition of $\interact{I}^*$, we have the following.

  $t,\sigma\interact{i_1}t_1,\sigma_1\interact{i_2}\cdots \interact{i_n}t_n,\sigma_n$ with $\Value(t_n,\sigma_n)$ and $I=[i_1,\cdots,i_n]$.

  We need to show that we have $(\tilde{v},\tilde{I},\Phi)\in t,\sigma\interact{}^*)$,
  which is defined as follows.

  \begin{align*}
      t,\sigma\interact{}&\tilde{t}_1,\tilde{\sigma}_1,\tilde{\imath}_1,\phi_1&\\
                      &\tilde{t}_1,\tilde{\sigma}_1\interact{}&\tilde{t}_2,\tilde{\sigma}_2,\tilde{\imath}_2,\phi_2\\
                      &                                    &\tilde{t}_2,\tilde{\sigma}_2\interact{}&\cdots&\\
                      &                                    &                                    &\cdots&
                      \interact{}\tilde{t}_n,\tilde{\sigma}_n,\tilde{\imath}_n,\phi_n
  \end{align*}

  with $\Value(\tilde{t}_n,\tilde{\sigma}_n)=\tilde{v}$ and $\Sat(\phi_1\land\cdots\land\phi_n)$.

  By \cref{lem:completedriving}, we know that $t,\sigma\interact{}\tilde{t}_1,\tilde{\sigma}_1,\tilde{\imath}_1,\phi_1$ exists,
  since $t,\sigma,t\Consistent_{\emptyset}\sigma,\True$.
  This also gives us that $\tilde{\imath}_1\sim i_1$ and $t_1,\sigma_1\Consistent_{[s_1\mapsto c_1]}\tilde{t}_1,\tilde{\sigma}_1,\phi_1$ with $s_1\in\tilde{\imath}_1$ and $c_1\in i_1$.

  By repeated application of \cref{lem:completedriving}, untill we arrive at $t_n,\sigma_n$,
  we can show that there exists a $\tilde{I}$ such that $t,\sigma\interact{}^*\tilde{t}_n,\tilde{\sigma}_n,\tilde{I},\Phi$,
  namely $[\tilde{\imath}_1,\cdots,\tilde{\imath}_n]$.

\end{proof}

$\Evaluate$ and $\Simulate$ make use of the driving and symbolic driving semantics respectively, so we also need prove those sound and complete with respect to each other.


\begin{proof}[Soundness of driving]
  The symbolic driving semantics consists of only one rule, \refrule{SI-Handle}.
  Given that $t,\sigma\Consistent_M\tilde{t},\tilde{\sigma},\Phi$ and $\tilde{t},\tilde{\sigma}\interact{}\overline{\tilde{t}',\tilde{\sigma}',\tilde{\imath},\phi_1}$,
  \cref{lem:soundhandle} gives us that for each pair $(\tilde{t}',\tilde{\sigma}',\tilde{\imath},\phi_1)$
  there exists an input $i$ such that $\tilde{\imath}\sim i$, $t,\sigma\handle{i}t',\sigma'$
  and $t',\sigma'\Consistent_{M.[s\mapsto c]}\tilde{t'},\tilde{\sigma'},\Phi\land\phi_1$.

  Then, by \cref{lem:soundnorm}, given that $\tilde{t'},\tilde{\sigma'}\normalise\overline{\tilde{t''},\tilde{\sigma''}',\phi_2}$,
  we obtain that for each pair $(\tilde{t''},\tilde{\sigma''}',\phi_2)$, we have that $\Sat(\Phi\land\phi_1\land\phi_2)$ implies
  that $t',\sigma'\hat{\normalise}t'',\sigma''$ with $t'',\sigma''\Consistent_{M.[s\mapsto c]}\tilde{t''},\tilde{\sigma''},\Phi\land\phi_1\land\phi_2$.
\end{proof}

Since the driving semantics in turn depends on the handling and normalisation semantics, we need to show that they too are sound and complete.
These lemma's and their fairly trivial proofs are listed in the appendix.


\subsection{Correctness of hints}

Now that soundness and completeness of simulate has been proven, we can prove that our hints function is correct.
We consider our function to be correct when it produces correct hints.
Intuitively, for a set of next step hints to be correct, they should adhere to the following requirements.

\begin{itemize}
  \item valid steps a user can actually take.
  \item bring the user closer to the desired goal.
  \item contain ALL steps that bring the user closer to their goal.
\end{itemize}

We separate these requirements into two lemma's, namely soundness and completeness.

\begin{theorem}[Soundness of hints]
  \label{thm:soundhint}

For all tasks $t$, states $\sigma$ and goals $g$,
for every next step hint $(\tilde{\imath},\Phi)$ in $\Hints(t,\sigma,g)$,
there exists a sequence of inputs $I$ and input $i$ such that $\tilde{\imath}\sim i$,
$\Sat([s\mapsto c]\Phi)$, $t,\sigma\interact{i} t',\sigma'\interact{I}^* v$ and $gv$.
\end{theorem}

\begin{theorem}[Completeness of hints]
  \label{thm:completehint}
  For all tasks $t$, states $\sigma$, lists of input $(i:is)$ and goals $g$,
  if $t,\sigma,\interact{i:is}^*v$ and $g v$, then there exists a symbolic input $\tilde{\imath}$ and path condition $\Phi$
  such that $(\tilde{\imath},\Phi)\in\Hints(t,\sigma)$ with $\tilde{\imath}\sim i$ and $\Sat([s\mapsto c]\Phi)$ with $c\in i$ and $s\in i$.
\end{theorem}


The proofs of these two threorems are quite straight forward.

\begin{proof}[\cref{thm:soundhint}]
  \cref{thm:soundhint} follows from the definition of $\Hints$ and \cref{lem:soundsimulate} as follows.

  The definition of $\Hints$ gives us that for every pair $(\tilde{\imath},\Phi)$ produced by $\Hints$,
  there exists a pair $(\tilde{v},\tilde{\imath}:\tilde{is},\Phi)$ with $\Sat(\Phi\land g \tilde{v})$.
  Then by \cref{lem:soundsimulate} we have that there exists a sequence of concrete inputs $I$ such that
  $t,\sigma\interact{I}^*v$ and $g v$.
\end{proof}


\begin{proof}[\cref{thm:completehint}]
  In order to prove that $i$ is contained in $\Hints(t,\sigma)$, we need to show that $(\tilde{v},\tilde{\imath}:\tilde{is},\Phi)\in t,\sigma\interact{}^*$, with $\tilde{\imath}\sim i$ and $\Sat([s_0\mapsto c_0,\cdots,s_n\mapsto c_n]\land g\tilde{v})$, where $[c_0,\cdots,c_n]\in i:is$ and $[s_0,\cdots,s_n]\in \tilde{\imath}:\tilde{is}$.

  By \cref{lem:completesimulate}, we directly obtain that this indeed exists. Therefore we know that $\tilde{\imath}$ and $\Phi$ exist.
\end{proof}
