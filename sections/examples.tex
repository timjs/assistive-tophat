% !TEX root=../main.tex

\section{Examples}
\label{sec:examples}

\subsection{Tax subsidy request}

The example program listed in this section is taken from our previous work on symbolic execution for \TOPHAT~\cite{Steenvoorden2019}.
It models a simplified tax subsidy application process for citizens who have installed solar panels.

A subsidy is only given under the following conditions.
\begin{itemize}
\item The roofing company has confirmed that they installed solar panels for the citizen.
\item The tax officer has approved the request.
\item The tax officer can only approve the request if the roofing company has confirmed, and the request is filed within one year of the invoice date.
\item The amount of the granted subsidy is maximal 600 EUR.
\end{itemize}

The listing below gives the \TOPHAT code for this example.

\lstset{emph={invoiceDate,today,confirmed,invoiceAmount,approved}}
\begin{TASK}[float=ht
            ,numbers=right
            ,caption=Subsidy request and approval workflow at the Dutch tax office.
            ,label=lst:tax
            ]
  let provideCitizenInformation = enter Date in

    let provideDocuments = enter Amount <&> enter Date in

      let companyConfirm = edit True <?> edit False in

        let officerApprove = \ invoiceDate. \ today. \ confirmed.
          edit False <?> if (today - invoiceDate < 365 /\ confirmed) |\label{lst:tax:officer-approve-def}| then edit True else fail in

            provideCitizenInformation >>= \ today.|\label{lst:tax:citizen-info}|
            provideDocuments <&> companyConfirm >>= |\label{lst:tax:documents-and-company-confirm}|
              \ <<<<invoiceAmount, invoiceDate>>, confirmed>>.
              officerApprove invoiceDate today confirmed >>= \ approved.|\label{lst:tax:officer-approve}|

          let subsidyAmount = if approved then min 600 (invoiceAmount / 10) else 0 in

            edit <<subsidyAmount, approved, confirmed, invoiceDate, today>>|\label{lst:tax:result}|
\end{TASK}

In previous work, we have shown that this code indeed adheres to the requirements listed above.

Instead of assisting the developer, by proving the program correct, we would now like to support the end user that is requesting a subsidy.

The end user wants the outcome of this program to be a subsidy amount larger than zero.

Running the simulation function will result in the following set:

\begin{align*}
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,\Left \Left amount,     \Left \Right i, \Right \Left, \Right],t-i<365)\\
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,    \Left \Right i, \Left \Left amount, \Right \Left, \Right],t-i<365)\\
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,      \Right \Left, \Left \Left amount, \Left \Right i, \Right],t-i<365)\\
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,      \Right \Left, \Left \Right i, \Left \Left amount, \Right],t-i<365)\\
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,    \Left \Right i, \Right \Left, \Left \Left amount, \Right],t-i<365)\\
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,\Left \Left amount, \Right \Left, \Left \Right i, \Right],t-i<365)\\
  ((                  0&, \False, \True, i, t),[t,\Left \Left amount, \Left \Right i, \Right \Left, \Left],\True)\\
  ((                  0&, \False, \True, i, t),[t,    \Left \Right i, \Left \Left amount, \Right \Left, \Left],\True)\\
  ((                  0&, \False, \True, i, t),[t,      \Right \Left, \Left \Left amount, \Left \Right i, \Left],\True)\\
  ((                  0&, \False, \True, i, t),[t,      \Right \Left, \Left \Right i, \Left \Left amount, \Left],\True)\\
  ((                  0&, \False, \True, i, t),[t,    \Left \Right i, \Right \Left, \Left \Left amount, \Left],\True)\\
  ((                  0&, \False, \True, i, t),[t,\Left \Left amount, \Right \Left, \Left \Right i, \Left],\True)\\
  ((                  0&, \False,\False, i, t),[t,\Left \Left amount, \Left \Right i, \Right \Right, \Left],\True)\\
  ((                  0&, \False,\False, i, t),[t,\Left \Right i, \Left \Left amount, \Right \Right, \Left],\True)\\
  ((                  0&, \False,\False, i, t),[t,\Right \Right,\Left \Left amount, \Left \Right i, \Left],\True)\\
  ((                  0&, \False,\False, i, t),[t,\Right \Right, \Left \Right i, \Left \Left amount, \Left],\True)\\
  ((                  0&, \False,\False, i, t),[t, \Left \Right i, \Right \Right, \Left \Left amount, \Left],\True)\\
  ((                  0&, \False,\False, i, t),[t, \Left \Left amount, \Right \Right, \Left \Right i, \Left],\True)\\
\end{align*}


As a goal we set that the subsidy amount should be larger than zero. This leaves us with the following cases.


\begin{align*}
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,\Left \Left amount,     \Left \Right i, \Right \Left, \Right],t-i<365)\\
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,    \Left \Right i, \Left \Left amount, \Right \Left, \Right],t-i<365)\\
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,      \Right \Left, \Left \Left amount, \Left \Right i, \Right],t-i<365)\\
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,      \Right \Left, \Left \Right i, \Left \Left amount, \Right],t-i<365)\\
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,    \Left \Right i, \Right \Left, \Left \Left amount, \Right],t-i<365)\\
  ((min 600 (amount/10)&,  \True, \True, i, t),[t,\Left \Left amount, \Right \Left, \Left \Right i, \Right],t-i<365)\\
\end{align*}

From the end states we can conclude that invoiceAmount should be larger than zero in order for the result to be larger than zero. This results in an additional constraint.

In the end, we can use the above to give hints to the user.

First, a date must be entered. Then the user can choose to ender an amount larger than zero, a date that is within 356 from now, or a "RL".
etc.
