% !TEX root=../main.tex

\section{Soundness proofs}
\label{sec:soundnessproofs}


\begin{proof}[Soundness of simulate]
  The structure of this proof is outlined in \cref{fig:proofstructure}.

  We have $t$ and $\sigma$ such that $t,\sigma\simulate\overline{\tilde{v},\tilde{I},\Phi}$.
  By definition of simulation $(\simulate)$, we know that for each tuple $(\tilde{v},\tilde{I},\Phi)$,
  the following sequence of symbolic drive steps has occurred.
  \begin{align*}
      t,\sigma\siminteract&\tilde{t}_1,\tilde{\sigma}_1,\simi_1,\phi_1&\\
                      &\tilde{t}_1,\tilde{\sigma}_1\siminteract&\tilde{t}_2,\tilde{\sigma}_2,\simi_2,\phi_2\\
                      &                                    &\tilde{t}_2,\tilde{\sigma}_2\siminteract&\cdots&\\
                      &                                    &                                    &\cdots&
                      \siminteract\tilde{t}_n,\tilde{\sigma}_n,\simi_n,\phi_n
  \end{align*}

  with $\Value(\tilde{t}_n,\tilde{\sigma}_n)=\tilde{v}$ and $\Sat(\phi_1\land\cdots\land\phi_n)$.

  We need to show that there exits an $I$ such that $t,\sigma\execute{I}v$, which is defined similarly as follows.

  $t,\sigma\interact{i_1}t_1,\sigma_1\interact{i_2}t_2,\sigma_2\interact{i_3}\cdots \interact{i_n}t_n,\sigma_n$ with $\Value(t_n,\sigma_n)$.

  By \cref{lem:sounddriving}, we know that $t,\sigma\interact{i_1}t_1,\sigma_1$ exists, since $t,\sigma\Consistent_{\emptyset}t,\sigma,\True$.
  This also gives us that $\tilde{i_1}\sim i_1$, and $t_1,\sigma_1\Consistent_{[s_1\mapsto c_1]}\tilde{t}_1,\tilde{\sigma}_1,\phi_1$ with $\SymOf(\sim_1)=s_1$ and $\ValOf(i_1)=c_1$.

  By repeatedly applying \cref{lem:sounddriving}, until we arrive at $\tilde{t}_n,\sigma{t}_n$,
  we can show that there indeed exists an $I$ such that $t,\sigma\execute{I}v$ with $[s_1\mapsto c_1,\cdots,s_n\mapsto c_n]\tilde{v}=v$
  and $[s_1\mapsto c_1,\cdots,s_n\mapsto c_n]\Phi$, namely $I=[i_1,\cdots,i_n]$.

\end{proof}






\begin{proof}[Soundness of driving]
  The symbolic driving semantics consists of only one rule, \refrule{SI-Handle}.
  Given that $t,\sigma\Consistent_M\tilde{t},\tilde{\sigma},\Phi$ and $\tilde{t},\tilde{\sigma}\siminteract\overline{\tilde{t}',\tilde{\sigma}',\simi,\phi_1}$,
  \cref{lem:soundhandle} gives us that for each pair $(\tilde{t}',\tilde{\sigma}',\simi,\phi_1)$
  there exists an input $i$ such that $\simi\sim i$, $t,\sigma\handle{i}t',\sigma'$
  and $t',\sigma'\Consistent_{M.[s\mapsto c]}\tilde{t'},\tilde{\sigma'},\Phi\land\phi_1$.

  Then, by \cref{lem:soundnorm}, given that $\tilde{t'},\tilde{\sigma'}\normalise\overline{\tilde{t''},\tilde{\sigma''}',\phi_2}$,
  we obtain that for each pair $(\tilde{t''},\tilde{\sigma''}',\phi_2)$, we have that $\Sat(\Phi\land\phi_1\land\phi_2)$ implies
  that $t',\sigma'\simnormalise t'',\sigma''$ with $t'',\sigma''\Consistent_{M.[s\mapsto c]}\tilde{t''},\tilde{\sigma''},\Phi\land\phi_1\land\phi_2$.
\end{proof}


\begin{lemma}[Soundness of handling]
  \label{lem:soundhandle}

  For all concrete tasks $t$, concrete states $\sigma$, symbolic tasks $\tilde{t}$, symbolic states $\tilde{\sigma}$ path conditions $\Phi$ and mappings $M$,
  we have that $t,\sigma\Consistent_{M}\tilde{t},\tilde{\sigma},\Phi$ implies
  that for all symbolic inputs $\simi$ such that $\tilde{t},\tilde{\sigma}\simhandle\overline{\tilde{t}',\tilde{\sigma}',\simi,\phi}$ and
  for all pairs $(\tilde{t}',\tilde{\sigma}',\simi,\phi)$,
  $\Sat(\Phi\land\phi)$ implies that there exists an input $i$ such that $\simi\sim i$,  $t,\sigma\handle{i}t',\sigma'$ and $t',\sigma'\Consistent_{M.[s\mapsto c]}\tilde{t}',\tilde{\sigma}',\Phi\land\phi$ where where $\SymOf(\simi)=s$ and $\ValOf(i)=c$.

\end{lemma}



\begin{lemma}[Soundness of normalisation]
  \label{lem:soundnorm}
  For all concrete expressions $e$, concrete states $\sigma$, symbolic expressions $\tilde{e}$, symbolic states $\tilde{\sigma}$ path conditions $\Phi$ and mappings $M$,
  we have that $e,\sigma\Consistent_{M}\tilde{e},\tilde{\sigma},\Phi$ implies
  that if $\tilde{e},\tilde{\sigma}\simnormalise\overline{\tilde{t},\tilde{\sigma}',\phi}$,
  then for all pairs $(\tilde{t},\tilde{\sigma}',\phi)$ it holds that $\Sat(\Phi\land\phi)$ implies
  that $e,\sigma\normalise t,\sigma'$ with $t,\sigma'\Consistent_{M}\tilde{t},\tilde{\sigma'},\Phi\land\phi$.
\end{lemma}

\begin{lemma}[Soundness of striding]
  \label{lem:soundstride}
  for all concrete tasks $t$, concrete states $\sigma$, symbolic tasks $\tilde{t}$, symbolic states $\tilde{\sigma}$ path conditions $\Phi$ and mappings $M$,
  we have that $t,\sigma\Consistent_{M}\tilde{t},\tilde{\sigma},\Phi$ implies
  that if $\tilde{t},\tilde{\sigma}\simstride\overline{\tilde{t}',\tilde{\sigma}',\phi}$,
  then for all pairs $(\tilde{t}',\tilde{\sigma}',\phi)$ it holds that $\Sat(\Phi\land\phi)$ implies
  that $t,\sigma\simstride t',\sigma'$ with $t',\sigma'\Consistent_{M}\tilde{t'},\tilde{\sigma'},\Phi\land\phi$.
\end{lemma}

\begin{lemma}[Soundness of evaluation]
  \label{lem:soundeval}
  For all concrete expressions $e$, concrete states $\sigma$, symbolic expressions $\tilde{e}$, symbolic states $\tilde{\sigma}$ path conditions $\Phi$ and mappings $M$,
  we have that $e,\sigma\Consistent_{M}\tilde{e},\tilde{\sigma},\Phi$ implies
  that if $\tilde{e},\tilde{\sigma}\simeval\overline{\tilde{v},\tilde{\sigma}',\phi}$,
  then for all pairs $(\tilde{v},\tilde{\sigma}',\phi)$ it holds that $\Sat(\Phi\land\phi)$ implies
  that $e,\sigma\simeval v,\sigma'$ with $v,\sigma'\Consistent_{M}\tilde{v},\tilde{\sigma'},\Phi\land\phi$.
\end{lemma}


\begin{proof}[Soundness of handle]

  We prove \cref{lem:soundhandle} by induction over $\tilde{t}$.

  \Case{$\tilde{t}=\Enter \tau$}
 {
 Since we have $t,\sigma\Consistent_M\Enter \tau,\tilde{\sigma},\Phi$, we know that $t$ must be $\Enter \tau$ too, $\tilde{t}$ contains no symbols.
 There exists only one symbolic execution, namely \Userule{SH-Fill}.
 We need to show that there exists an $i$ such that $s\sim i$ and $\Edit v,\sigma\handle{i}t',\sigma'$.

 Any concrete value $c$ of type $\tau$ will do. Now we have to show that we end up with $\Edit c,\sigma\Consistent_{M.[s\mapsto c]}\Edit s,\tilde{\sigma},\Phi\land\True$, which holds trivially.
 }

  \Case{$\tilde{t}=\Edit \tilde{v}$}
  {
  Since we have $t,\sigma\Consistent_M\Edit \tilde{v},\tilde{\sigma},\Phi$, we know that either $\tilde{v}$ is a concrete value, or $M$ contains a mapping such that $M\tilde{v}$ becomes a concrete value $c$. We know therefore that $t$ must be $\Edit c$.

  There exists only one symbolic execution, namely \Userule{SH-Change}.
  We need to show that there exists an $i$ such that $s\sim i$ and $\Edit c,\sigma\handle{i}t',\sigma'$.

  Any concrete value $c'$ of the same type as $c$ will do. Now we have to show that we end up with $\Edit c',\sigma\Consistent_{M.[s\mapsto c']}\Edit s,\tilde{\sigma},\Phi\land\True$, which holds trivially.
  }


\Case{$\tilde{t}=\Update l$}
{
Since we have $t,\sigma\Consistent_M\Update l,\tilde{\sigma},\Phi$, we know that $t$ must be $\Update l$ too, $\tilde{t}$ contains no symbols.
There exists only one symbolic execution, namely \Userule{SH-Update}.
We need to show that there exists an $i$ such that $s\sim i$ and $\Update l,\sigma\handle{i}t',\sigma'$.

Any concrete value $c$ of the same type as $l$ will do. Now we have to show that we end up with $\Update l,\sigma[l\mapsto c]\Consistent_{M.[s\mapsto c]}\Update l,\tilde{\sigma}[l\mapsto s],\Phi\land\True$, which holds trivially.
}


\Case{$\tilde{t}=\tilde{t}_1\Next \tilde{e}_2$}
 {
Since we have $t,\sigma\Consistent_M\tilde{t}_1\Next \tilde{e}_2,\tilde{\sigma},\Phi$, we know that $M \tilde{t}_1\Next \tilde{e}_2=t$, which comes down to $t_1\Next e_2$ for some concrete $t_1$ and $e_2$.

 In this case, three rules apply.\\

 \Case{\Userule{SH-Next}}

{
In this case, we have two sets of symbolic executions.

For all tuples $(\tilde{t}_1'\Next \tilde{e}_2,\tilde{\sigma}_1',\simi,\phi_1)$, we know by application of the induction hypothesis that
there exits an $i$ such that $\simi\sim i$, $t_1,\sigma\handle{i}t_1',\sigma'$ and
$t_1',\sigma'\Consistent_{M.[s\mapsto c]}\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi_1$ where $\ValOf(i)=c$ and $\ValOf(\simi)=s$.
Therefore we also have $t_1'\Next e_2,\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1'\Next \tilde{e}_2,\tilde{\sigma}_1',\Phi\land\phi_1$.

For all tuples $(\tilde{t}_2,\tilde{\sigma}_2',\Continue,\phi_2)$, we first have by \cref{lem:valpres} that
$v_1,\sigma\Consistent_M\tilde{v}_1,\tilde{\sigma},\Phi$.
Now, before we can apply \cref{lem:soundnorm}, we need to establish that
$e_2\ v_1,\sigma\Consistent_M\tilde{e}_2\ \tilde{v}_1,\tilde{\sigma},\Phi$ holds.
This means that we have to show that $M \tilde{e}_2\ \tilde{v}_1 = e_2\ v_1$.
Since application of the mapping is distributive, it suffices to show that $M\tilde{v}_1=v_1$, which is given,
and $M\tilde{e}_2=e_2$, which follows from the premise as well.

At this point, by application of \cref{lem:soundnorm}, we obtain that $e_2\ v_1,\sigma\normalise t_2,\sigma_2'$
and $t_1,\sigma_2'\Consistent_M\tilde{t}_2,\tilde{\sigma}_2',\Phi\land\phi_2$
}

\Case{\Userule{SH-PassNext}}
{
For all tuples $(\tilde{t}_1'\Next \tilde{e}_2,\tilde{\sigma}_1',\simi,\phi_1)$, we know by application of the induction hypothesis that
there exits an $i$ such that $\simi\sim i$, $t_1,\sigma\handle{i}t_1',\sigma'$ and
$t_1',\sigma'\Consistent_{M.[s\mapsto c]}\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi_1$ where $\ValOf(i)=c$ and $\ValOf(\simi)=s$.
Therefore we also have $t_1'\Next e_2,\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1'\Next \tilde{e}_2,\tilde{\sigma}_1',\Phi\land\phi_1$.
}

\Case{\Userule{SH-PassNextFail}}
{
For all tuples $(\tilde{t}_1'\Next \tilde{e}_2,\tilde{\sigma}_1',\simi,\phi_1)$, we know by application of the induction hypothesis that
there exits an $i$ such that $\simi\sim i$, $t_1,\sigma\handle{i}t_1',\sigma'$ and
$t_1',\sigma'\Consistent_{M.[s\mapsto c]}\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi_1$ where $\ValOf(i)=c$ and $\ValOf(\simi)=s$.
Therefore we also have $t_1'\Next e_2,\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1'\Next \tilde{e}_2,\tilde{\sigma}_1',\Phi\land\phi_1$.
}
}

\Case{$\tilde{t}=\tilde{t}_1\Then \tilde{e}_2$}
{One rule applies, namely \Userule{SH-PassThen}\\
For all tuples $(\tilde{t}_1'\Then\tilde{e}_2,\tilde{\sigma}',\simi,\phi)$, we know by application of the induction hypothesis that
there exists an $i$ such that $\simi\sim i$, $t_1,\sigma\handle{1}t_1',\sigma'$ and
$t_1',\sigma'\Consistent_{M.[s\mapsto c]}\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi_1$ where $\ValOf(i)=c$ and $\SymOf(\simi)=s$.
Therefore we also have $t_1'\Then e_2,\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1'\Then \tilde{e}_2,\tilde{\sigma}_1',\Phi\land\phi_1,M.[s\mapsto c])$.
}

\Case{$\tilde{t}=\tilde{e}_1\Xor \tilde{e}_2$}
 {
In this case, three rules apply.\\
   \Case{\Userule{SH-Pick}}
   {
   In this case, we have two sets of symbolic executions.

   For all tuples $(\tilde{t}_1,\tilde{\sigma}_1,\Left,\phi_1)$,
   we obtain from \cref{lem:soundnorm} that $e_1,\sigma\normalise t_1,\sigma_1$ with
   $t_1,\sigma_1\Consistent_M\tilde{t}_1,\tilde{\sigma}_1,\Phi\land\phi_1$.

   For all tuples $(\tilde{t}_2,\tilde{\sigma}_2,\Right,\phi_2)$,
   we obtain from \cref{lem:soundnorm} that $e_2,\sigma\normalise t_2,\sigma_2$ with
   $t_2,\sigma_2\Consistent_M\tilde{t}_2,\tilde{\sigma}_2,\Phi\land\phi_2$.
   }
%
 \Case{\Userule{SH-PickLeft}}
  {
  For all tuples $(\tilde{t}_1,\tilde{\sigma}_1,\Left,\phi_1)$,
  we obtain from \cref{lem:soundnorm} that $e_1,\sigma\normalise t_1,\sigma_1$ with
  $t_1,\sigma_1\Consistent_M\tilde{t}_1,\tilde{\sigma}_1,\Phi\land\phi_1$.
%
}
  \Case{\Userule{SH-PickRight}}
  {
  For all tuples $(\tilde{t}_2,\tilde{\sigma}_2,\Right,\phi_2)$,
  we obtain from \cref{lem:soundnorm} that $e_2,\sigma\normalise t_2,\sigma_2$ with
  $t_2,\sigma_2\Consistent_M\tilde{t}_2,\tilde{\sigma}_2,\Phi\land\phi_2$.
  }
 }
%
\Case{$\tilde{t}=\tilde{t}_1\And \tilde{t}_2$}
{
In this case, one rule applies. \Userule{SH-And}

In this case, we have two sets of symbolic executions.

  For all tuples $(\tilde{t}_1'\And\tilde{t}_2,\tilde{\sigma}_1',\First \simi_1,\phi_1)$,
  we know by application of the induction hypothesis that there exists an $i$ such that
  $\simi_1\sim i$, $t_1,\sigma\handle{i}t_1',\sigma_1'$ and
  $t_1',\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1',\tilde{\sigma}_1',\Phi\land\phi_1$.
  Then by \refrule{H-FirstAnd}, we know that also $t_1\And t_2,\sigma\handle{\First i}t_1'\And t_2,\sigma_1'$.
  It follows trivially that $t_1'\And t_2,\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1'\And \tilde{t}_2,\tilde{\sigma}_1',\Phi\land\phi_1$.

  For all tuples $(\tilde{t}_1\And\tilde{t}_2',\tilde{\sigma}_2',\Second \simi_2,\phi_2)$,
  we know by application of the induction hypothesis that there exists an $i$ such that
  $\simi_2\sim i$, $t_2,\sigma\handle{i}t_2',\sigma_2'$ and
  $t_2',\sigma_2'\Consistent_{M.[s\mapsto c]}\tilde{t}_2',\tilde{\sigma}_2',\Phi\land\phi_2$.
  Then by \refrule{H-SecondAnd}, we know that also $t_1\And t_2,\sigma\handle{\Second i}t_1\And t_2',\sigma_2'$.
  It follows trivially that $t_1\And t_2',\sigma_2'\Consistent_{M.[s\mapsto c]}\tilde{t}_1\And \tilde{t}_2',\tilde{\sigma}_2',\Phi\land\phi_2$.
}
%
 \Case{$\tilde{t}=\tilde{e}_1\Or \tilde{e}_2$}
{One rule applies, namely \Userule{SH-Or}\\
In this case, we have two sets of symbolic executions.

  For all tuples $(\tilde{t}_1'\Or\tilde{t}_2,\tilde{\sigma}_1',\First \simi_1,\phi_1)$,
  we know by application of the induction hypothesis that there exists an $i$ such that
  $\simi_1\sim i$, $t_1,\sigma\handle{i}t_1',\sigma_1'$ and
  $t_1',\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1',\tilde{\sigma}_1',\Phi\land\phi_1$.
  Then by \refrule{H-FirstOr}, we know that also $t_1\Or t_2,\sigma\handle{\First i}t_1'\Or t_2,\sigma_1'$.
  It follows trivially that $t_1'\Or t_2,\sigma_1'\Consistent_{M.[s\mapsto c]}\tilde{t}_1'\Or \tilde{t}_2,\tilde{\sigma}_1',\Phi\land\phi_1$.

  For all tuples $(\tilde{t}_1\Or\tilde{t}_2',\tilde{\sigma}_2',\Second \simi_2,\phi_2)$,
  we know by application of the induction hypothesis that there exists an $i$ such that
  $\simi_2\sim i$, $t_2,\sigma\handle{i}t_2',\sigma_2'$ and
  $t_2',\sigma_2'\Consistent_{M.[s\mapsto c]}\tilde{t}_2',\tilde{\sigma}_2',\Phi\land\phi_2$.
  Then by \refrule{H-SecondOr}, we know that also $t_1\Or t_2,\sigma\handle{\Second i}t_1\Or t_2',\sigma_2'$.
  It follows trivially that $t_1\Or t_2',\sigma_2'\Consistent_{M.[s\mapsto c]}\tilde{t}_1\Or \tilde{t}_2',\tilde{\sigma}_2',\Phi\land\phi_2$.
}

\end{proof}


\begin{lemma}[$\Value$ preserves consistence]
  \label{lem:valpres}
  For all concrete tasks $t$, concrete states $\sigma$, symbolic tasks $\tilde{t}$, symbolic states $\tilde{\sigma}$, path conditions $\Phi$ and mappings $M=[s_1\mapsto c_1\cdots s_n\mapsto c_n]$,
  if $t,\sigma\Consistent_M\tilde{t},\tilde{\sigma},\Phi$ and $\Value(t,\sigma)=v$ and $\Value(\tilde{t},\tilde{\sigma})$,
  then also $v,\sigma\Consistent_M\tilde{v},\tilde{\sigma},\Phi$
\end{lemma}

\begin{proof}[$\Value$ preserves consistence]

  \Case{$\tilde{t}=\Edit s$}
    {
    If we have $t,\sigma\Consistent_M\Edit s,\tilde{\sigma},\Phi$, then we know that $t$ must be $\Edit c$ for some concrete value of the same type as $s$.

    Then by definition of $\Value$, we have $\Value(\Edit c,\sigma)=c$ and $\Value(\Edit s,\tilde{\sigma})=s$.
    Since we have $M(\Edit s)=\Edit c$ from the premise, we know that $M s = c$, since mapping propagates.
    Therefore $c,\sigma\Consistent_M s,\tilde{\sigma},\Phi$.
    }

  \Case{$\tilde{t}=\Enter \tau$}
    {
    If we have $t,\sigma\Consistent_M\Enter \tau,\tilde{\sigma},\Phi$, then we know that $t$ is also $\Enter\tau$.

    By definition of $\Value$, $\Value(\Enter \tau,\sigma)=\bot$ and $\Value(\Enter\tau,\tilde{\sigma})=\bot$,
    so this case holds trivially.
    }

  \Case{$\tilde{t}=\Update l$}
    {
    If we have $t,\sigma\Consistent_M\Update l,\tilde{\sigma},\Phi$, then we know that $t$ is also $\Update l$.

    By definition of $\Value$, $\Value(\Update l,\sigma)=\sigma(l)$ and $\Value(\Update l,\tilde{\sigma})=\tilde{\sigma}(l)$.

    We now need to show that $M(\tilde{\sigma}(l))=\sigma(l)$. From the premise we know that $M\tilde{\sigma}=\sigma$, from which this immediately follows.
    }

  \Case{$\tilde{t}=\Fail$}
    {
    If we have $t,\sigma\Consistent_M\Fail,\tilde{\sigma},\Phi$, then we know that $t$ is also $\Fail$.

    By definition of $\Value$, $\Value(\Fail,\sigma)=\bot$ and $\Value(\Fail,\tilde{\sigma})=\bot$, so we know that this case holds trivially.
    }

  \Case{$\tilde{t}=\tilde{t}_1\Then \tilde{e}_2$}
    {
    If we have $t,\sigma\Consistent_M\tilde{t}_1\Then \tilde{e}_2,\tilde{\sigma},\Phi$, then we know that $t$ is $t_1\Then e_2$.

    By definition of $\Value$, $\Value(t_1\Then e_2,\sigma)=\bot$ and $\Value(\tilde{t}_1\Then \tilde{e}_2,\tilde{\sigma})=\bot$, so we know that this case holds trivially.

    }


  \Case{$\tilde{t}=\tilde{t}_1\Next \tilde{e}_2$}
    {
    If we have $t,\sigma\Consistent_M\tilde{t}_1\Next \tilde{e}_2,\tilde{\sigma},\Phi$, then we know that $t$ is $t_1\Next e_2$.

    By definition of $\Value$, $\Value(t_1\Next e_2,\sigma)=\sigma(l)$ and $\Value(\tilde{t}_1\Next \tilde{e}_2,\tilde{\sigma})=\bot$, so we know that this case holds trivially.

    }

  \Case{$\tilde{t}=\tilde{t}_1\And \tilde{t}_2$}
    {
    If we have $t,\sigma\Consistent_M\tilde{t}_1\And \tilde{t}_2,\tilde{\sigma},\Phi$, then we know that $t$ is also $t_1\And t_2$.

    By definition of $\Value$, we can find ourselves in one of two cases.

    If $\Value(\tilde{t}_1,\sigma)=\tilde{v}_1$ and $\Value(\tilde{t}_2,\sigma)=\tilde{v}_2$,
    then $\Value(t_1\And t_2,\sigma)=\tuple{v_1,v_2}$ and $\Value(\tilde{t}_1\And \tilde{t}_2,\tilde{\sigma})=\tuple{\tilde{v}_1,\tilde{v}_2}$.
    This case follows from the induction hypothesis.

    Otherwise, if either one of the two branches returns $\bot$, we have that
    $\Value(t_1\And t_2,\sigma)=\bot$ and $\Value(\tilde{t}_1\And \tilde{t}_2,\tilde{\sigma})=\bot$,
    so we know that this case holds trivially

    }

  \Case{$\tilde{t}=\tilde{t}_1\Or \tilde{t}_2$}
    {
    If we have $t,\sigma\Consistent_M\tilde{t}_1\Or \tilde{t}_2,\tilde{\sigma},\Phi$, then we know that $t$ is also $t_1\Or t_2$.

    By definition of $\Value$, we find ourselves in one of three cases.

    If $\Value(\tilde{t}_1,\tilde{\sigma})=\tilde{v}_1$, then $\Value(\tilde{t}_1\Or\tilde{t}_2,\tilde{\sigma})=\tilde{v}_1$
    and $\Value(t_1\Or t_2,\sigma)=v_1$. This case follows from the induction hypothesis.

    Otherwise, if $\Value(\tilde{t}_2,\tilde{\sigma})=\tilde{v}_2$, then $\Value(\tilde{t}_1\Or\tilde{t}_2,\tilde{\sigma})=\tilde{v}_2$
    and $\Value(t_1\Or t_2,\sigma)=v_2$. This case follows from the induction hypothesis.

    Otherwise, if either one of the two branches returns $\bot$, we have that
    $\Value(t_1\Or t_2,\sigma)=\bot$ and $\Value(\tilde{t}_1\Or \tilde{t}_2,\tilde{\sigma})=\bot$,
    so we know that this case holds trivially.

    }

  \Case{$\tilde{t}=\tilde{t}_1\Xor \tilde{t}_2$}
    {
    If we have $t,\sigma\Consistent_M\tilde{t}_1\Xor \tilde{t}_2,\tilde{\sigma},\Phi$, then we know that $t$ is $t_1\Xor t_2$.

    By definition of $\Value$, $\Value(t_1\Xor t_2,\sigma)=\bot$ and $\Value(\tilde{t}_1\Xor \tilde{t}_2,\tilde{\sigma})=\bot$, so we know that this case holds trivially.

    }
\end{proof}

\begin{proof}[Soundness of normalise]
  We prove Lemma~\ref{lem:soundnorm} by induction over $\tilde{e}$.

  From the premise, we can assume that $e,\sigma\Consistent_M\tilde{e},\tilde{\sigma},\Phi$.
  Now, given that $\tilde{e},\sigma{e}\simnormalise \overline{\tilde{t},\tilde{\sigma}',\phi}$,
  we need to demonstrate that for all pairs $(\tilde{t},\tilde{\sigma}',\phi)$,
  $\Sat(\Phi\land\phi)$ implies that $e,\sigma\normalise t,\sigma'$ with $t,\sigma'\Consistent_M\tilde{t},\tilde{\sigma}',\Phi\land\phi$.

The base case is when the SN-Done rule applies.\\
\Userule{SN-Done}\\

In this case, we obtain from \cref{lem:soundeval} that
$e,\sigma\normalise t,\sigma'$ with $t,\sigma'\Consistent_M\tilde{t},\tilde{\sigma}',\Phi\land\phi$,
which is exactly what we needed to show.

The only induction step is when\\
\Userule{SN-Repeat} applies.

In this case, we obtain from \cref{lem:soundeval} that
$e,\sigma\normalise t,\sigma'$ with $t,\sigma'\Consistent_M\tilde{t},\tilde{\sigma}',\Phi\land\phi_1$,
which is exactly what we needed to show.
Furthermore, by \cref{lem:soundstride} we obtain that
$t,\sigma'\stride t',\sigma''$ with $t',\sigma''\Consistent_M\tilde{t}',\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
Then finally, by application of the induction hypothesis, we obtain what we needed to prove.
$t',\sigma''\normalise t'',\sigma'''$ with $t'',\sigma'''\Consistent_M\tilde{t}'',\tilde{\sigma}''',\Phi\land\phi_1\land\phi_2\land\phi_3$.

\end{proof}

\begin{proof}[Soundness of stride]

  Provided that $t,\sigma\Consistent_M\tilde{t},\tilde{\sigma},\Phi$ and $\tilde{t},\tilde{\sigma}\simstride \overline{\tilde{t}',\tilde{\sigma}',\phi}$,
  we want to show that for all pairs $(\tilde{t}',\tilde{\sigma}',\phi)$,
  we have $\Sat(\Phi\land\phi)$ implies that $t,\sigma\stride t',\sigma'$
  We prove Lemma~\ref{lem:soundstride} by induction over $t$.



  \Case{$\tilde{t}=\Edit \tilde{v}$}
  { One rule applies, namely \Userule{SS-Edit}\\
    Given that $t,\sigma\Consistent_M\Edit\tilde{v},\tilde{\sigma},\Phi$ and $\Edit\tilde{v},\tilde{\sigma}\simstride\Edit\tilde{v},\tilde{\sigma},\True$,
    we know that $t=\Edit M \tilde{v}$, and we have $\Edit M \tilde{v},\sigma\stride\Edit M\tilde{v},\sigma$ by \refrule{S-Edit} and
    $\Edit M \tilde{v},\sigma\Consistent_M\Edit\tilde{v},\tilde{\sigma},\Phi$, since none of the tasks and states were altered.
   }
  %
   \Case{$t=\Enter \tau$}
  {One rule applies, namely \Userule{SS-Fill}\\
  Given that $t,\sigma\Consistent_M\Enter \tau,\tilde{\sigma},\Phi$ and $\Enter \tau,\tilde{\sigma}\simstride\Enter \tau,\tilde{\sigma},\True$,
  we know that $t=\Enter \tau$, and we have $\Enter \tau,\sigma\stride\Enter \tau,\sigma$ by \refrule{S-Fill} and
  $\Enter \tau,\sigma\Consistent_M\Edit\tilde{v},\tilde{\sigma},\Phi$, since none of the tasks and states were altered.
  }

  \Case{$t=\Update l$}
   {One rule applies, namely \Userule{SS-Update}\\
   Given that $t,\sigma\Consistent_M\Update l,\tilde{\sigma},\Phi$ and $\Update l,\tilde{\sigma}\simstride\Update l,\tilde{\sigma},\True$,
   we know that $t=\Update l$, and we have $\Update l,\sigma\stride\Update l,\sigma$ by \refrule{S-Update} and
   $\Update l,\sigma\Consistent_M\Update l,\tilde{\sigma},\Phi$, since none of the tasks and states were altered.
  }

  \Case{$t=\Fail$}
   {One rule applies, namely \Userule{SS-Fail}\\
   Given that $t,\sigma\Consistent_M\Fail,\tilde{\sigma},\Phi$ and $\Fail,\tilde{\sigma}\simstride\Fail,\tilde{\sigma},\True$,
   we know that $t=\Fail$, and we have $\Fail,\sigma\stride\Fail,\sigma$ by \refrule{S-Fail} and
   $\Fail,\sigma\Consistent_M\Fail,\tilde{\sigma},\Phi$, since none of the tasks and states were altered.
   }
  %
  \Case{$t=\tilde{e}_1\Xor \tilde{e}_2$}
   {One rule applies, namely \Userule{SS-Xor}\\
   Given that $t,\sigma\Consistent_M\tilde{e}_1\Xor \tilde{e}_2,\tilde{\sigma},\Phi$ and $\tilde{e}_1\Xor \tilde{e}_2,\tilde{\sigma}\simstride\tilde{e}_1\Xor \tilde{e}_2,\tilde{\sigma},\True$,
   we know that $t=M\tilde{e}_1\Xor M\tilde{e}_2$, and we have $M\tilde{e}_1\Xor M\tilde{e}_2,\sigma\stride M\tilde{e}_1\Xor M\tilde{e}_2,\sigma$ by \refrule{S-Xor} and
   $M\tilde{e}_1\Xor M\tilde{e}_2,\sigma\Consistent_M\tilde{e}_1\Xor \tilde{e}_2,\tilde{\sigma},\Phi$, since none of the tasks and states were altered.
   }




\Case{$\tilde{t}=\tilde{t}_1\Then \tilde{e}_2$}
 {
Three rules apply.\\
 \Case{\Userule{SS-ThenStay}}
   {
     Provided that $t,\sigma\Consistent_M\tilde{t}_1\Then \tilde{e}_2,\tilde{\sigma},\Phi$
     and $\tilde{t}_1\Then \tilde{e}_2,\tilde{\sigma}\simstride\tilde{t}'_1\Then \tilde{e}_2,\tilde{\sigma}',\phi_1$,
     we obtain from the induction hypothesis that $t_1,\sigma\stride t_1',\sigma'$ and $t_1',\sigma'\Consistent_M\tilde{t}_1',\tilde{\sigma}',\Phi$.
     From this, we can directly conclude that $t_1\Then e_2,\sigma\stride t_1'\Then e_2,\sigma'$ and $t_1'\Then e_2,\sigma'\Consistent_M\tilde{t}_1'\Then\tilde{e}_2,\tilde{\sigma}',\Phi$.
  }
 \Case{\Userule{SS-ThenFail}}
   { Provided that $t,\sigma\Consistent_M\tilde{t}_1\Then \tilde{e}_2,\tilde{\sigma},\Phi$
   and $\tilde{t}_1\Then \tilde{e}_2,\tilde{\sigma}\simstride\tilde{t}'_1\Then \tilde{e}_2,\tilde{\sigma}',\phi_1$,
   we obtain from the induction hypothesis that $t_1,\sigma\stride t_1',\sigma'$ and $t_1',\sigma'\Consistent_M\tilde{t}_1',\tilde{\sigma}',\Phi$.
   From this, we can directly conclude that $t_1\Then e_2,\sigma\stride t_1'\Then e_2,\sigma'$ and $t_1'\Then e_2,\sigma'\Consistent_M\tilde{t}_1'\Then\tilde{e}_2,\tilde{\sigma}',\Phi$.
   }
 \Case{\Userule{SS-ThenCont}}
   {Provided that $t,\sigma\Consistent_M\tilde{t}_1\Then \tilde{e}_2,\tilde{\sigma},\Phi$
   and $\tilde{t}_1\Then \tilde{e}_2,\tilde{\sigma}\simstride\tilde{t}_2,\tilde{\sigma}',\phi_1\land\phi_2$
   with $\tilde{t}_1,\tilde{\sigma}\simstride\tilde{t}_1',\tilde{\sigma}',\phi_1$ and $\Value(\tilde{t}_1',\tilde{\sigma}')=\tilde{v}_1$,
   we obtain from the induction hypothesis that $t_1,\sigma\stride t_1',\sigma'$ and $t_1',\sigma'\Consistent_M\tilde{t}_1',\tilde{\sigma}',\Phi$.
   Then from the consistence relation, we can conclude that $\Value(t_1',\sigma')=\Value(M t_1',M \sigma')=M\tilde{v}_1$.

   At this point, we have $e_2 M\tilde{v}_1,\sigma'\Consistent_M\tilde{e}_2 \tilde{v}_1,\tilde{\sigma}',\Phi\land\phi_1$ and $\tilde{e}_2 \tilde{v}_1,\tilde{\sigma}'\simeval\tilde{t}_2,\tilde{sigma}'',\phi_2$.
   This allows us to apply \cref{lem:soundeval} to obtain $e_2 (M\tilde{v}_1),\sigma'\eval t_2,\sigma''$ and $t_2,\sigma''\Consistent_M\tilde{t}_2,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.

   From this, we can directly conclude that $t_1\Then e_2,\sigma\stride t_2,\sigma''$ and $t_2,\sigma''\Consistent_M\tilde{t}_2,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.

   }
 }

\Case{$\tilde{t}=\tilde{t}_1\Or \tilde{t}_2$}
 {
One of three rules applies.\\
\Case{\Userule{SS-OrLeft}}
   {Provided that $t,\sigma\Consistent_M\tilde{t}_1\Or \tilde{t}_2,\tilde{\sigma},\Phi$
   and $\tilde{t}_1\Or \tilde{t}_2,\tilde{\sigma}\simstride\tilde{t}'_1,\tilde{\sigma}',\phi$,
   we obtain from the induction hypothesis that $t_1,\sigma\stride t_1',\sigma'$ and $t_1',\sigma'\Consistent_M\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi$.
   From this, we can directly conclude that $t_1\Or t_2,\sigma\stride t_1',\sigma'$.
  }
 \Case{\Userule{SS-OrRight}}
   { Provided that $t,\sigma\Consistent_M\tilde{t}_1\Or \tilde{t}_2,\tilde{\sigma},\Phi$
   and $\tilde{t}_1\Or \tilde{t}_2,\tilde{\sigma}\simstride\tilde{t}'_2,\tilde{\sigma}'',\phi_1\land\phi_2$,
   we obtain from the induction hypothesis that $t_1,\sigma\stride t_1',\sigma'$ and $t_1',\sigma'\Consistent_M\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi_1$.
   Then by a second application of the induction hypothesis, we obtain that $t_2,\sigma'\stride t_2',\sigma''$ and $t_2',\sigma''\Consistent_M\tilde{t}_2',\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
   This leads us to conclude $t_1\Or t_2,\sigma\stride t_2',\sigma''$.
   }
\Case{\Userule{SS-OrNone}}
  {  Provided that $t,\sigma\Consistent_M\tilde{t}_1\Or \tilde{t}_2,\tilde{\sigma},\Phi$
  and $\tilde{t}_1\Or \tilde{t}_2,\tilde{\sigma}\simstride\tilde{t}'_2,\tilde{\sigma}'',\phi_1\land\phi_2$,
  we obtain from the induction hypothesis that $t_1,\sigma\stride t_1',\sigma'$ and $t_1',\sigma'\Consistent_M\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi_1$.
  Then by a second application of the induction hypothesis, we obtain that $t_2,\sigma'\stride t_2',\sigma''$ and $t_2',\sigma''\Consistent_M\tilde{t}_2',\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
  This leads us to conclude $t_1\Or t_2,\sigma\stride t_1'\Or t_2',\sigma''$ and $t_1'\Or t_2',\sigma''\Consistent_M\tilde{t}_1'\Or\tilde{t}_2',\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
   }
 }

 \Case{$\tilde{t}=\tilde{t}_1\Next \tilde{e}_2$}
 {One rule applies, namely \Userule{SS-Next}\\
 Provided that $t,\sigma\Consistent_M\tilde{t}_1\Next \tilde{e}_2,\tilde{\sigma},\Phi$
 and $\tilde{t}_1\Next \tilde{e}_2,\tilde{\sigma}\simstride\tilde{t}'_1\Then \tilde{e}_2,\tilde{\sigma}',\phi$,
 we obtain from the induction hypothesis that $t_1,\sigma\stride t_1',\sigma'$ and $t_1',\sigma'\Consistent_M\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi$.
 From this, we can directly conclude that $t_1\Next e_2,\sigma\stride t_1'\Next e_2,\sigma'$ and $t_1'\Next e_2,\sigma'\Consistent_M\tilde{t}_1'\Next\tilde{e}_2,\tilde{\sigma}',\Phi\land\phi$.
}

\Case{$\tilde{t}=\tilde{t}_1\And \tilde{t}_2$}
{One rule applies, namely \Userule{SS-And}\\
Provided that $t,\sigma\Consistent_M\tilde{t}_1\And \tilde{t}_2,\tilde{\sigma},\Phi$
and $\tilde{t}_1\And \tilde{t}_2,\tilde{\sigma}\simstride\tilde{t}'_1\And\tilde{t}'_2,\tilde{\sigma}'',\phi_1\land\phi_2$,
we obtain from the induction hypothesis that $t_1,\sigma\stride t_1',\sigma'$ and $t_1',\sigma'\Consistent_M\tilde{t}_1',\tilde{\sigma}',\Phi\land\phi_1$.
Then by a second application of the induction hypothesis, we obtain that $t_2,\sigma'\stride t_2',\sigma''$ and $t_2',\sigma''\Consistent_M\tilde{t}_2',\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
This leads us to conclude $t_1\And t_2,\sigma\stride t_1'\And t_2',\sigma''$ and $t_1'\And t_2',\sigma''\Consistent_M\tilde{t}_1'\And\tilde{t}_2',\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.

}

\end{proof}

\begin{proof}[Soundness of evaluate]

  We prove Lemma~\ref{lem:soundeval} by induction over $\tilde{e}$.

  \Case{$\tilde{e}=\tilde{v}$}
    {One rule applies, namely \Userule{SE-Value}\\
    We assume $e,\sigma\Consistent_M\tilde{v},\tilde{\sigma},\Phi$ and $\tilde{v},\tilde{\sigma}\simeval\tilde{v},\tilde{\sigma},\True$.
    By \refrule{E-Value} we have $v,\sigma\eval v,\sigma$, so this case holds trivially.
    }

  \Case{$\tilde{e}=\tuple{\tilde{e}_1,\tilde{e}_2}$}
    {One rule applies, namely \Userule{SE-Pair}\\
    Provided that $e,\sigma\Consistent_m\tuple{\tilde{e}_1,\tilde{e}_2},\tilde{\sigma},\Phi$ and $\tuple{\tilde{e}_1,\tilde{e}_2},\tilde{\sigma}\simeval\tuple{\tilde{v}_1,\tilde{v}_2},\tilde{\sigma}'',\phi_1\land\phi_2$,
    we obtain from the induction hypothesis that $e_1,\sigma\eval v_1,\sigma'$ with $v_1,\sigma'\Consistent_m\tilde{v}_1,\tilde{\sigma}',\Phi\land\phi_1$.
    Then by a second application of the induction hypothesis, we obtain that $e_2,\sigma'\eval v_2,\sigma''$ with $v_2,\sigma''\Consistent_m\tilde{v}_2,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
    From this, we can conclude that $\tuple{e_1,e_2},\sigma\eval\tuple{v_1,v_2},\sigma''$ with $\tuple{v_1,v_2},\sigma''\Consistent_m\tuple{\tilde{v}_1,\tilde{v}_2},\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
    }

  \Case{$\tilde{e}=\Fst \tuple{\tilde{e}_1,\tilde{e}_2}$}
  {
    One rule applies, namely \Userule{SE-First}\\
    Provided that $e,\sigma\Consistent_m\Fst\tuple{\tilde{e}_1,\tilde{e}_2},\tilde{\sigma},\Phi$ and $\Fst\tuple{\tilde{e}_1,\tilde{e}_2},\tilde{\sigma}\simeval\tilde{v}_1,\tilde{\sigma}'',\phi$,
    we obtain from the induction hypothesis that $e_1,\sigma\eval v_1,\sigma'$ with $v_1,\sigma'\Consistent_m\tilde{v}_1,\tilde{\sigma}',\Phi\land\phi$.
    From this, we can conclude that $\Fst\tuple{e_1,e_2},\sigma\eval v_1,\sigma'$.
    }

  \Case{$e=\Snd \tuple{\tilde{e}_1,\tilde{e}_2}$}
  { One rule applies, namely \Userule{SE-Second}\\
  Provided that $e,\sigma\Consistent_m\Snd\tuple{\tilde{e}_1,\tilde{e}_2},\tilde{\sigma},\Phi$ and $\Snd\tuple{\tilde{e}_1,\tilde{e}_2},\tilde{\sigma}\simeval\tilde{v}_2,\tilde{\sigma}'',\phi$,
  we obtain from the induction hypothesis that $e_1,\sigma\eval v_2,\sigma'$ with $v_2,\sigma'\Consistent_m\tilde{v}_1,\tilde{\sigma}',\Phi\land\phi$.
  From this, we can conclude that $\Snd\tuple{e_1,e_2},\sigma\eval v_2,\sigma'$.
    }

  \Case{$\tilde{e}=\tilde{e}_1::\tilde{e}_2$}
    {One rule applies, namely \Userule{SE-Cons}\\
    Provided that $e,\sigma\Consistent_m\tilde{e}_1::\tilde{e}_2,\tilde{\sigma},\Phi$ and $\tilde{e}_1::\tilde{e}_2,\tilde{\sigma}\simeval\tilde{v}_1::\tilde{v}_2,\tilde{\sigma}'',\phi_1\land\phi_2$,
    we obtain from the induction hypothesis that $e_1,\sigma\eval v_1,\sigma'$ with $v_1,\sigma'\Consistent_m\tilde{v}_1,\tilde{\sigma}',\Phi\land\phi_1$.
    Then by a second application of the induction hypothesis, we obtain that $e_2,\sigma'\eval v_2,\sigma''$ with $v_2,\sigma''\Consistent_m\tilde{v}_2,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
    From this, we can conclude that $e_1 :: e_2,\sigma\eval v_1 :: v_2,\sigma''$ with $v_1 :: v_2,\sigma''\Consistent_m\tilde{v}_1 :: \tilde{v}_2,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
   }

  \Case{$\tilde{e}=\Head \tilde{e}$}
    {One rule applies, namely \Userule{SE-Head}\\
    Provided that $e,\sigma\Consistent_m\Head \tilde{e},\tilde{\sigma},\Phi$ and $\Head \tilde{e},\tilde{\sigma}\simeval\tilde{v}_1,\tilde{\sigma}',\phi$,
    we obtain from the induction hypothesis that $e,\sigma\eval v_1::v_2,\sigma'$ with $v_1::v_2,\sigma'\Consistent_m\tilde{v}_1::\tilde{v}_2,\tilde{\sigma}',\Phi\land\phi$.
    From this, we can conclude that $\Head e,\sigma\eval v_1,\sigma'$.
    }

  \Case{$\tilde{e}=\Tail \tilde{e}$}
    {One rule applies, namely \Userule{SE-Tail}\\
    Provided that $e,\sigma\Consistent_m\Tail \tilde{e},\tilde{\sigma},\Phi$ and $\Tail \tilde{e},\tilde{\sigma}\simeval\tilde{v}_2,\tilde{\sigma}',\phi$,
    we obtain from the induction hypothesis that $e,\sigma\eval v_1::v_2,\sigma'$ with $v_1::v_2,\sigma'\Consistent_m\tilde{v}_1::\tilde{v}_2,\tilde{\sigma}',\Phi\land\phi$.
    From this, we can conclude that $\Tail e,\sigma\eval v_2,\sigma'$.
      }

  \Case{$\tilde{e}=\tilde{e}_1 \tilde{e}_2$}
    {One rule applies, namely\\ \Userule{SE-App}\\

    Provided that $e,\sigma\Consistent_m\tilde{e}_1 \tilde{e}_2,\tilde{\sigma},\Phi$ and $\tilde{e}_1 \tilde{e}_2,\tilde{\sigma}\simeval\tilde{v}_1,\tilde{\sigma}''',\phi_1\land\phi_2\land\phi_3$,
    we obtain from the induction hypothesis that $e_1,\sigma\eval \lambda x:\tau.{e_1}',\sigma'$ with $\lambda x:\tau.{e_1}',\sigma'\Consistent_m\lambda x:\tau.\tilde{e}_1',\tilde{\sigma}',\Phi\land\phi_1$.
    Then by a second application of the induction hypothesis, we obtain that $e_2,\sigma'\eval v_2,\sigma''$ with $v_2,\sigma''\Consistent_m\tilde{v}_2,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
    A third and final application of the induction hypothesis gives us that $e_1'[x\mapsto v_2],\sigma'' \eval v_1,\sigma'''$ with
    $v_1,\sigma'''\Consistent_m\tilde{v}_1,\tilde{\sigma}''',\Phi\land\phi_1\land\phi_2\land\phi_3$.
    From this, we can conclude that $e_1 e_2,\sigma\eval v_1,\sigma'''$.
    }

  \Case{$\tilde{e}=\If{\tilde{e}_1}{\tilde{e}_2}{\tilde{e}_3}$}
     {One rule applies, namely\\ \userule{SE-If}\\
     Provided that $e,\sigma\Consistent_m\If{\tilde{e}_1}{\tilde{e}_2}{\tilde{e}_3},\tilde{\sigma},\Phi$ and \userule{SE-IF},
     we obtain from the induction hypothesis that $e_1,\sigma\eval v_1,\sigma'$ with $v_1,\sigma'\Consistent_m \tilde{v}_1,\tilde{\sigma}',\Phi\land\phi_1$.
     At this point, we have two potential branches.
     Applying the induction hypothesis to either of them, we obtain that $e_2,\sigma'\eval v_2,\sigma''$ with $v_2,\sigma''\Consistent_m\tilde{v}_2,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$
     and $e_3,\sigma'\eval v_3,\sigma''$ with $v_3,\sigma''\Consistent_m\tilde{v}_3,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_3$.
     From this, we can conclude that $\If{e_1}{e_2}{e_3},\sigma\eval v_2,\sigma''$ with $v_2,\sigma''\Consistent_M\tilde{v}_2,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$
     or $\If{e_1}{e_2}{e_3},\sigma\eval v_3,\sigma''$ with $v_3,\sigma''\Consistent_M\tilde{v}_3,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_3$.
    }

  \Case{$\tilde{e}=\Ref \tilde{e}$}
    {One rule applies, namely \Userule{SE-Ref}\\
    Provided that $e,\sigma\Consistent_m\Ref \tilde{e},\tilde{\sigma},\Phi$ and $\Ref \tilde{e},\tilde{\sigma}\simeval l,\tilde{\sigma}'[l\mapsto\tilde{v}],\phi$,
    we obtain from the induction hypothesis that $e,\sigma\eval v_1,\sigma'$ with $v_1,\sigma'\Consistent_m\tilde{v}_1,\tilde{\sigma}',\Phi\land\phi$.
    From this, we can conclude that $\Ref e,\sigma\eval l,\sigma'[l\mapsto v]$ with $l,\sigma'[l\mapsto v]\Consistent_m l,\tilde{\sigma}'[l\mapsto \tilde{v}],\Phi\land\phi$.
    }

  \Case{$\tilde{e}=!\tilde{e}$}
    {One rule applies, namely \Userule{SE-Deref}\\
    Provided that $e,\sigma\Consistent_m !\tilde{e},\tilde{\sigma},\Phi$ and $!\tilde{e},\tilde{\sigma}\simeval\tilde{\sigma}'(l),\tilde{\sigma}',\phi$,
    we obtain from the induction hypothesis that $e,\sigma\eval l,\sigma'$ with $l,\sigma'\Consistent_m l,\tilde{\sigma}',\Phi\land\phi$.
    From this, we can conclude that $!e,\sigma\eval \sigma'(l),\sigma'$ with $\sigma'(l),\sigma'\Consistent_m \tilde{\sigma}'(l),\tilde{\sigma}',\Phi\land\phi$.
  }

  \Case{$\tilde{e}=\tilde{e}_1:=\tilde{e}_2$}
    {
    One rule applies, namely \Userule{SE-Assign}\\
    Provided that $e,\sigma\Consistent_m\tilde{e}_1:=\tilde{e}_2,\tilde{\sigma},\Phi$ and $\tilde{e}_1:=\tilde{e}_2,\tilde{\sigma}\simeval\unit,\tilde{\sigma}''[l\mapsto \tilde{v}_2],\phi_1\land\phi_2$,
    we obtain from the induction hypothesis that $e_1,\sigma\eval l,\sigma'$ with $l,\sigma'\Consistent_m l,\tilde{\sigma}',\Phi\land\phi_1$.
    Then by a second application of the induction hypothesis, we obtain that $e_2,\sigma'\eval v_2,\sigma''$ with $v_2,\sigma''\Consistent_m\tilde{v}_2,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
    From this, we can conclude that $e_1 := e_2,\sigma\eval \unit,\sigma''[l\mapsto v_2]$ with $\unit,\sigma''[l\mapsto v_2]\Consistent_m\unit,\tilde{\sigma}''[l\mapsto\tilde{v}_2],\Phi\land\phi_1\land\phi_2$.
    }

  \Case{$\tilde{e}=\Edit \tilde{e}$}
    {One rule applies, namely \Userule{SE-Edit}\\
    Provided that $e,\sigma\Consistent_m \Edit\tilde{e},\tilde{\sigma},\Phi$ and $\Edit\tilde{e},\tilde{\sigma}\simeval\Edit\tilde{v},\tilde{\sigma}',\phi$,
    we obtain from the induction hypothesis that $e,\sigma\eval v,\sigma'$ with $v,\sigma'\Consistent_m \tilde{v},\tilde{\sigma}',\Phi\land\phi$.
    From this, we can conclude that $\Edit e,\sigma\eval \Edit v,\sigma'$ with $\Edit v,\sigma'\Consistent_m \Edit\tilde{v},\tilde{\sigma}',\Phi\land\phi$.

    }

  \Case{$\tilde{e}=\Enter \tau$}
    {
    One rule applies, namely \Userule{SE-Enter}\\
    We assume $e,\sigma\Consistent_M\Enter\tau,\tilde{\sigma},\Phi$ and $\Enter\tau,\tilde{\sigma}\simeval\Enter\tau,\tilde{\sigma},\True$.
    By \refrule{E-Enter} we have $\Enter\tau,\sigma\eval \Enter\tau,\sigma$, so this case holds trivially.
    }

  \Case{$\tilde{e}=\Update \tilde{e}$}
    {One rule applies, namely \Userule{SE-Update}\\
    Provided that $e,\sigma\Consistent_m \Update\tilde{e},\tilde{\sigma},\Phi$ and $\Update\tilde{e},\tilde{\sigma}\simeval\Update l,\tilde{\sigma}',\phi$,
    we obtain from the induction hypothesis that $e,\sigma\eval l,\sigma'$ with $l,\sigma'\Consistent_m l,\tilde{\sigma}',\Phi\land\phi$.
    From this, we can conclude that $\Update e,\sigma\eval \Update l ,\sigma'$ with $\Update l,\sigma'\Consistent_m \Update l,\tilde{\sigma}',\Phi\land\phi$.

    }

  \Case{$\tilde{e}=\tilde{e}_1\Then \tilde{e}_2$}
    {One rule applies, namely \Userule{SE-Then}\\
    Provided that $e,\sigma\Consistent_m \tilde{e}_1\Then \tilde{e}_2,\tilde{\sigma},\Phi$ and $\tilde{e}_1\Then \tilde{e}_2,\tilde{\sigma}\simeval\tilde{t}_1\Then \tilde{e}_2,\tilde{\sigma}',\phi$,
    we obtain from the induction hypothesis that $e_1,\sigma\eval t_1,\sigma'$ with $t_1,\sigma'\Consistent_m \tilde{t}_1,\tilde{\sigma}',\Phi\land\phi$.
    From this, we can conclude that $e_1\Then e_2,\sigma\eval t_1\Then e_2,\sigma'$ with $t_1\Then e_2,\sigma'\Consistent_m \tilde{t}_1\Then e_2,\tilde{\sigma}',\Phi\land\phi$.

    }

  \Case{$\tilde{e}=\tilde{e}_1\Next \tilde{e}_2$}
    {One rule applies, namely \Userule{SE-Next}\\
    Provided that $e,\sigma\Consistent_m \tilde{e}_1\Next \tilde{e}_2,\tilde{\sigma},\Phi$ and $\tilde{e}_1\Next \tilde{e}_2,\tilde{\sigma}\simeval\tilde{t}_1\Next \tilde{e}_2,\tilde{\sigma}',\phi$,
    we obtain from the induction hypothesis that $e_1,\sigma\eval t_1,\sigma'$ with $t_1,\sigma'\Consistent_m \tilde{t}_1,\tilde{\sigma}',\Phi\land\phi$.
    From this, we can conclude that $e_1\Next e_2,\sigma\eval t_1\Next e_2,\sigma'$ with $t_1\Next e_2,\sigma'\Consistent_m \tilde{t}_1\Next e_2,\tilde{\sigma}',\Phi\land\phi$.

    }

  \Case{$\tilde{e}=\tilde{e}_1\Or \tilde{e}_2$}
    {One rule applies, namely \Userule{SE-Or}\\
    Provided that $e,\sigma\Consistent_m\tilde{e}_1 \Or \tilde{e}_2,\tilde{\sigma},\Phi$ and $\tilde{e}_1 \Or \tilde{e}_2,\tilde{\sigma}\simeval\tilde{v}_1\Or \tilde{v}_2,\tilde{\sigma}'',\phi_1\land\phi_2$,
    we obtain from the induction hypothesis that $e_1,\sigma\eval v_1,\sigma'$ with $v_1,\sigma'\Consistent_m\tilde{v}_1,\tilde{\sigma}',\Phi\land\phi_1$.
    Then by a second application of the induction hypothesis, we obtain that $e_2,\sigma'\eval v_2,\sigma''$ with $v_2,\sigma''\Consistent_m\tilde{v}_2,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.
    From this, we can conclude that $e_1 \Or e_2,\sigma\eval v_1 \Or v_2,\sigma''$ with $v_1 \Or v_2,\sigma''\Consistent_m\tilde{v}_1 \Or \tilde{v}_2,\tilde{\sigma}'',\Phi\land\phi_1\land\phi_2$.

    }

  \Case{$\tilde{e}=\tilde{e}_1\Xor \tilde{e}_2$}
    {  One rule applies, namely \Userule{SE-Xor}\\
    We assume $e,\sigma\Consistent_M\tilde{e}_1\Xor \tilde{e}_2,\tilde{\sigma},\Phi$ and $\tilde{e}_1\Xor \tilde{e}_2,\tilde{\sigma}\simeval\tilde{e}_1\Xor \tilde{e}_2,\tilde{\sigma},\True$.
    By \refrule{E-Xor} we have $e_1\Xor e_2,\sigma\eval e_1\Xor e_2,\sigma$, so this case holds trivially.

    }

  \Case{$\tilde{e}=\Fail$}
    {  One rule applies, namely \Userule{SE-Fail}\\
    We assume $e,\sigma\Consistent_M\Fail,\tilde{\sigma},\Phi$ and $\Fail,\tilde{\sigma}\simeval\Fail,\tilde{\sigma},\True$.
    By \refrule{E-Fail} we have $\Fail,\sigma\eval \Fail,\sigma$, so this case holds trivially.

    }

\end{proof}
